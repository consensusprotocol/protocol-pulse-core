{% extends "base.html" %}

{% block title %}Podcasts - Protocol Pulse{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

<style>
:root {
    --pp-red: #dc2626;
    --pp-black: #000000;
    --pp-glass: rgba(0, 0, 0, 0.75);
    --pp-glass-border: rgba(255, 255, 255, 0.08);
    --pp-blur: 45px;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

.podcast-page {
    min-height: 100vh;
    background: var(--pp-black);
    padding-top: 80px;
    position: relative;
}

.podcast-page::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(ellipse at 20% 0%, rgba(220, 38, 38, 0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 100%, rgba(220, 38, 38, 0.04) 0%, transparent 40%);
    pointer-events: none;
    z-index: 0;
}

.podcast-page > * {
    position: relative;
    z-index: 1;
}

.sovereign-card {
    background: var(--pp-glass);
    backdrop-filter: blur(var(--pp-blur));
    -webkit-backdrop-filter: blur(var(--pp-blur));
    border: 1px solid var(--pp-glass-border);
    border-radius: 20px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
}

.sovereign-card:hover {
    border-color: rgba(220, 38, 38, 0.4);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px rgba(220, 38, 38, 0.1);
    transform: translateY(-6px);
}

.page-hero {
    text-align: center;
    padding: 60px 0 50px;
}

.page-hero h1 {
    font-family: 'Crimson Pro', serif;
    font-size: clamp(2.5rem, 5vw, 4rem);
    font-weight: 700;
    color: #fff;
    letter-spacing: -1px;
    margin-bottom: 12px;
}

.page-hero h1 i {
    color: var(--pp-red);
    margin-right: 16px;
}

.page-hero .subtitle {
    font-family: 'Crimson Pro', serif;
    font-size: 1.15rem;
    color: rgba(255, 255, 255, 0.5);
    font-weight: 400;
    letter-spacing: 0.5px;
}

.primary-signal-section {
    margin-bottom: 60px;
}

.primary-signal-card {
    background: linear-gradient(135deg, rgba(220, 38, 38, 0.08) 0%, var(--pp-glass) 100%);
    backdrop-filter: blur(var(--pp-blur));
    -webkit-backdrop-filter: blur(var(--pp-blur));
    border: 1px solid var(--pp-glass-border);
    border-radius: 24px;
    padding: 40px;
    position: relative;
    overflow: hidden;
}

.primary-signal-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--pp-red), transparent);
    opacity: 0.5;
}

.signal-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(220, 38, 38, 0.15);
    border: 1px solid rgba(220, 38, 38, 0.3);
    border-radius: 50px;
    padding: 8px 18px;
    margin-bottom: 20px;
}

.signal-badge i {
    color: var(--pp-red);
    font-size: 0.85rem;
}

.signal-badge span {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--pp-red);
    text-transform: uppercase;
    letter-spacing: 2px;
}

.signal-title {
    font-family: 'Crimson Pro', serif;
    font-size: 2rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 8px;
    letter-spacing: -0.5px;
}

.signal-series {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.6);
    margin-bottom: 24px;
}

.sarah-brief {
    background: var(--pp-glass);
    backdrop-filter: blur(var(--pp-blur));
    -webkit-backdrop-filter: blur(var(--pp-blur));
    border: 1px solid var(--pp-glass-border);
    border-left: 3px solid var(--pp-red);
    border-radius: 12px;
    padding: 24px;
    position: relative;
}

.sarah-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.sarah-avatar {
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, var(--pp-red), #b91c1c);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    color: #fff;
}

.sarah-name {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem;
    color: var(--pp-red);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.sarah-role {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    color: rgba(255, 255, 255, 0.4);
}

.sarah-quote {
    font-family: 'Crimson Pro', serif;
    font-size: 1.1rem;
    color: rgba(255, 255, 255, 0.85);
    line-height: 1.7;
    font-style: italic;
}

.intelligence-alliance {
    margin-bottom: 60px;
}

.section-title {
    font-family: 'Crimson Pro', serif;
    font-size: 1.75rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 8px;
    letter-spacing: -0.5px;
}

.section-subtitle {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem;
    color: rgba(255, 255, 255, 0.4);
    text-transform: uppercase;
    letter-spacing: 2px;
    margin-bottom: 30px;
}

.alliance-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 24px;
}

.alliance-card {
    background: var(--pp-glass);
    backdrop-filter: blur(var(--pp-blur));
    -webkit-backdrop-filter: blur(var(--pp-blur));
    border: 1px solid var(--pp-glass-border);
    border-radius: 20px;
    padding: 28px;
    text-align: center;
    transition: all 0.4s ease;
}

.alliance-card:hover {
    border-color: rgba(220, 38, 38, 0.4);
    transform: translateY(-4px);
}

.alliance-avatar {
    width: 80px;
    height: 80px;
    background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
    border: 2px solid var(--pp-glass-border);
    border-radius: 50%;
    margin: 0 auto 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    color: rgba(255, 255, 255, 0.3);
    overflow: hidden;
}

.alliance-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.alliance-name {
    font-family: 'Crimson Pro', serif;
    font-size: 1.2rem;
    font-weight: 600;
    color: #fff;
    margin-bottom: 8px;
}

.alliance-category {
    display: inline-block;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem;
    font-weight: 600;
    color: var(--pp-red);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    background: rgba(220, 38, 38, 0.1);
    border: 1px solid rgba(220, 38, 38, 0.2);
    border-radius: 50px;
    padding: 4px 12px;
    margin-bottom: 16px;
}

.alliance-stats {
    display: flex;
    justify-content: center;
    gap: 24px;
}

.alliance-stat {
    text-align: center;
}

.alliance-stat-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.1rem;
    font-weight: 700;
    color: #fff;
}

.alliance-stat-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.65rem;
    color: rgba(255, 255, 255, 0.4);
    text-transform: uppercase;
    letter-spacing: 1px;
}

.podcast-bento {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 28px;
    padding: 0;
}

.podcast-tile {
    position: relative;
}

.podcast-cover-glass {
    position: relative;
    height: 200px;
    overflow: hidden;
    border-radius: 20px 20px 0 0;
}

.podcast-cover-glass img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.6s ease;
}

.sovereign-card:hover .podcast-cover-glass img {
    transform: scale(1.08);
}

.play-overlay-glass {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.2) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.4s ease;
}

.sovereign-card:hover .play-overlay-glass {
    opacity: 1;
}

.play-btn-glass {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: var(--pp-red);
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.play-btn-glass:hover {
    transform: scale(1.12);
    box-shadow: 0 0 40px rgba(220, 38, 38, 0.6);
}

.podcast-meta-glass {
    padding: 24px;
}

.podcast-meta-glass .episode-tag {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--pp-red);
    margin-bottom: 10px;
}

.podcast-meta-glass h5 {
    font-family: 'Crimson Pro', serif;
    color: #fff;
    font-weight: 600;
    font-size: 1.15rem;
    margin-bottom: 14px;
    line-height: 1.4;
}

.podcast-meta-glass .description {
    font-family: 'Crimson Pro', serif;
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.55);
    line-height: 1.65;
    margin-bottom: 18px;
}

.podcast-meta-glass .meta-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.72rem;
    color: rgba(255, 255, 255, 0.4);
    margin-bottom: 18px;
}

.podcast-actions {
    display: flex;
    gap: 10px;
}

.podcast-actions .btn {
    flex: 1;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 10px 16px;
    border-radius: 10px;
}

.podcast-actions .btn-primary {
    background: var(--pp-red);
    border: none;
}

.podcast-actions .btn-primary:hover {
    background: #b91c1c;
}

.podcast-actions .btn-outline-light {
    background: transparent;
    border: 1px solid var(--pp-glass-border);
    color: rgba(255, 255, 255, 0.6);
}

.podcast-actions .btn-outline-light:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.2);
    color: #fff;
}

.section-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 32px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--pp-glass-border);
}

.section-header h2 {
    font-family: 'Crimson Pro', serif;
    font-size: 1.5rem;
    font-weight: 600;
    color: #fff;
    margin: 0;
    letter-spacing: -0.5px;
}

.section-header .rss-icon {
    color: var(--pp-red);
}

.empty-state {
    text-align: center;
    padding: 80px 20px;
}

.empty-state i {
    font-size: 4rem;
    color: rgba(255, 255, 255, 0.1);
    margin-bottom: 24px;
}

.empty-state h3 {
    font-family: 'Crimson Pro', serif;
    color: rgba(255, 255, 255, 0.4);
    margin-bottom: 12px;
}

.empty-state p {
    font-family: 'Crimson Pro', serif;
    color: rgba(255, 255, 255, 0.3);
    margin-bottom: 24px;
}

@media (max-width: 992px) {
    .alliance-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .page-hero {
        padding: 40px 0 30px;
    }
    
    .primary-signal-card {
        padding: 28px;
    }
    
    .alliance-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .podcast-bento {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .podcast-actions {
        flex-wrap: wrap;
    }
    
    .podcast-actions .btn {
        flex: 1 1 auto;
    }
}
</style>
{% endblock %}

{% block content %}
<section class="podcast-page">
    <div class="container">
        <div class="page-hero">
            <h1><i class="fas fa-podcast"></i>Protocol Pulse Podcasts</h1>
            <p class="subtitle">Deep intelligence on Bitcoin, monetary policy, and sovereign finance</p>
        </div>
        
        <!-- Primary Signal: Institutional Grade -->
        <div class="primary-signal-section">
            <div class="primary-signal-card">
                <div class="signal-badge">
                    <i class="fas fa-broadcast-tower"></i>
                    <span>Primary Signal: Institutional Grade</span>
                </div>
                
                <h2 class="signal-title">The Big Print Series</h2>
                <p class="signal-series">Cypherpunk'd x Lawrence Lepard // 12 Episodes</p>
                
                <div class="sarah-brief">
                    <div class="sarah-header">
                        <div class="sarah-avatar">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <div>
                            <div class="sarah-name">Sarah</div>
                            <div class="sarah-role">The Macro // Protocol Pulse Intelligence</div>
                        </div>
                    </div>
                    <p class="sarah-quote">
                        "The debt spiral is the signal. Larry Lepard's tactical breakdown of fiscal dominance is mandatory for rank advancement. This series exposes how the Federal Reserve engineered the greatest wealth extraction in human history — and why Bitcoin is the only exit."
                    </p>
                </div>
            </div>
        </div>

        {% if not podcast_sections_list %}
        <div class="alert alert-dark border border-danger rounded-pill text-center mb-4" style="background: rgba(0,0,0,0.7); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;">
            <span style="color: var(--pp-red);"><i class="fas fa-microphone-slash me-2"></i>No episodes generated yet.</span>
            <span class="ms-2 text-muted">From the admin Command Deck, run <strong>“Generate podcasts from all partners”</strong> to populate this page from your trusted YouTube channels.</span>
        </div>
        {% endif %}

        {% if podcast_sections_list %}
        {% for section in podcast_sections_list %}
        <div class="mb-5">
            <div class="section-header">
                <i class="fas fa-rss rss-icon fa-lg"></i>
                <h2>{{ section.name }}</h2>
            </div>
            <div class="podcast-bento">
                {% for podcast in section.podcasts %}
                <div class="podcast-tile">
                    <div class="sovereign-card h-100">
                        <div class="podcast-cover-glass">
                            {% if podcast.cover_image_url %}
                                <img src="{{ podcast.cover_image_url }}" alt="{{ podcast.title }}">
                            {% else %}
                                <div style="width: 100%; height: 100%; background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-microphone fa-3x" style="color: var(--pp-red); opacity: 0.4;"></i>
                                </div>
                            {% endif %}
                            
                            <div class="play-overlay-glass">
                                <button class="play-btn-glass" onclick="playPodcastGlobal('{{ podcast.id }}')">
                                    <i class="fas fa-play"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="podcast-meta-glass">
                            <div class="episode-tag">
                                Episode {{ podcast.episode_number or 'N/A' }}
                                {% if podcast.duration %} &bull; {{ podcast.duration }}{% endif %}
                            </div>
                            
                            <h5>{{ podcast.title }}</h5>
                            
                            <p class="description">
                                {{ (podcast.description[:100] + '...') if podcast.description and podcast.description|length > 100 else (podcast.description or 'Deep dive into Bitcoin and sovereign finance.') }}
                            </p>
                            
                            <div class="meta-row">
                                <span><i class="fas fa-user me-1"></i>{{ podcast.host or 'Protocol Pulse' }}</span>
                                <span>{{ podcast.published_date.strftime('%b %d, %Y') if podcast.published_date else '' }}</span>
                            </div>
                            
                            <div class="podcast-actions">
                                <button class="btn btn-primary btn-sm" onclick="playPodcastGlobal('{{ podcast.id }}')">
                                    <i class="fas fa-play me-1"></i>Play
                                </button>
                                <button class="btn btn-outline-light btn-sm" onclick="downloadPodcast('{{ podcast.id }}')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="btn btn-outline-light btn-sm" onclick="sharePodcast('{{ podcast.id }}')">
                                    <i class="fas fa-share"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            <div id="more-episodes-{{ section.slug }}" class="row g-4 mt-2" style="display: none;"></div>
            
            <div class="row mt-4">
                <div class="col-12 text-center">
                    <button class="btn btn-outline-light" 
                            style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; padding: 12px 28px; border-radius: 50px; border-color: var(--pp-glass-border);"
                            id="see-more-btn-{{ section.slug }}"
                            data-section-name="{{ section.name }}"
                            onclick="loadMoreEpisodes('{{ section.name | e }}', '{{ section.slug }}')">
                        <i class="fas fa-chevron-down me-2"></i>See More Episodes
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}

        {% else %}
        <div class="empty-state">
            <i class="fas fa-microphone"></i>
            <h3>Podcasts Coming Soon</h3>
            <p>We're working on bringing you exciting discussions about Bitcoin and sovereign finance.</p>
            <div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
                <a href="{{ url_for('index') }}" class="btn btn-primary" style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; padding: 12px 24px; border-radius: 50px;">
                    <i class="fas fa-home me-2"></i>Back to Home
                </a>
                <a href="{{ url_for('articles') }}" class="btn btn-outline-light" style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; padding: 12px 24px; border-radius: 50px; border-color: var(--pp-glass-border);">
                    <i class="fas fa-newspaper me-2"></i>Read Articles
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</section>

<!-- Sovereign Audio Bar - Persistent Global Player -->
<div id="sovereignAudioBar" class="position-fixed bottom-0 start-0 end-0" style="display: none; background: rgba(0, 0, 0, 0.95); backdrop-filter: blur(45px); -webkit-backdrop-filter: blur(45px); border-top: 1px solid rgba(255, 255, 255, 0.08); z-index: 9999;">
    <div class="container py-3">
        <div class="row align-items-center">
            <div class="col-1">
                <div id="albumArt" style="width: 50px; height: 50px; background: linear-gradient(135deg, #1a1a1a, #0a0a0a); border-radius: 10px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.08);">
                    <i class="fas fa-podcast" style="color: var(--pp-red);"></i>
                </div>
            </div>
            <div class="col-3">
                <h6 id="currentTitle" class="mb-0 text-white text-truncate" style="font-family: 'Crimson Pro', serif; font-size: 0.95rem; font-weight: 600;">Podcast Title</h6>
                <small id="currentHost" style="color: rgba(255,255,255,0.4); font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;">Host Name</small>
            </div>
            <div class="col-4">
                <div class="d-flex align-items-center gap-3 justify-content-center">
                    <button class="btn btn-link text-white p-0" onclick="seekBackward()" style="opacity: 0.6;"><i class="fas fa-backward"></i></button>
                    <button class="btn p-0" onclick="togglePlayPause()" style="width: 48px; height: 48px; background: var(--pp-red); border-radius: 50%; border: none;">
                        <i id="playPauseIcon" class="fas fa-play text-white"></i>
                    </button>
                    <button class="btn btn-link text-white p-0" onclick="seekForward()" style="opacity: 0.6;"><i class="fas fa-forward"></i></button>
                </div>
                <div class="d-flex align-items-center gap-2 mt-2">
                    <span id="currentTime" style="font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: rgba(255,255,255,0.4);">0:00</span>
                    <div class="flex-grow-1" style="height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; cursor: pointer;" onclick="seekTo(event)">
                        <div id="progressBar" style="height: 100%; width: 0%; background: var(--pp-red); border-radius: 2px; transition: width 0.1s;"></div>
                    </div>
                    <span id="totalTime" style="font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: rgba(255,255,255,0.4);">0:00</span>
                </div>
            </div>
            <div class="col-2 text-center">
                <button class="btn btn-link text-white p-0 me-3" onclick="adjustSpeed()" title="Playback Speed" style="opacity: 0.6;">
                    <span id="speedLabel" style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;">1x</span>
                </button>
                <button class="btn btn-link text-white p-0" onclick="toggleVolume()" title="Volume" style="opacity: 0.6;">
                    <i id="volumeIcon" class="fas fa-volume-up"></i>
                </button>
            </div>
            <div class="col-2 text-end">
                <button class="btn btn-link p-0" onclick="closePlayer()" style="color: rgba(255,255,255,0.4);">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    </div>
    <audio id="audioElement" style="display: none;"></audio>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentPodcast = null;
let playbackSpeeds = [0.75, 1, 1.25, 1.5, 2];
let currentSpeedIndex = 1;
let isMuted = false;

function playPodcastGlobal(podcastId) {
    fetch(`/api/podcast/${podcastId}`)
        .then(response => response.json())
        .then(podcast => {
            if (!podcast.audio_url) {
                alert('Audio not available for this episode yet.');
                return;
            }
            
            currentPodcast = podcast;
            document.getElementById('currentTitle').textContent = podcast.title;
            document.getElementById('currentHost').textContent = podcast.host || 'Protocol Pulse';
            
            const albumArt = document.getElementById('albumArt');
            if (podcast.cover_image_url && albumArt) {
                albumArt.innerHTML = `<img src="${podcast.cover_image_url}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">`;
            }
            
            document.getElementById('sovereignAudioBar').style.display = 'block';
            
            const audioElement = document.getElementById('audioElement');
            audioElement.src = podcast.audio_url;
            audioElement.play();
            
            updatePlayPauseIcon(true);
        })
        .catch(error => {
            console.error('Error loading podcast:', error);
            alert('Unable to load podcast. Please try again.');
        });
}

function playPodcast(podcastId) {
    playPodcastGlobal(podcastId);
}

function togglePlayPause() {
    const audioElement = document.getElementById('audioElement');
    if (audioElement.paused) {
        audioElement.play();
        updatePlayPauseIcon(true);
    } else {
        audioElement.pause();
        updatePlayPauseIcon(false);
    }
}

function updatePlayPauseIcon(isPlaying) {
    const icon = document.getElementById('playPauseIcon');
    icon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play';
}

function adjustSpeed() {
    const audioElement = document.getElementById('audioElement');
    currentSpeedIndex = (currentSpeedIndex + 1) % playbackSpeeds.length;
    const newSpeed = playbackSpeeds[currentSpeedIndex];
    audioElement.playbackRate = newSpeed;
    document.getElementById('speedLabel').textContent = newSpeed + 'x';
}

function closePlayer() {
    const audioElement = document.getElementById('audioElement');
    audioElement.pause();
    audioElement.currentTime = 0;
    document.getElementById('sovereignAudioBar').style.display = 'none';
}

function seekForward() {
    const audioElement = document.getElementById('audioElement');
    audioElement.currentTime = Math.min(audioElement.currentTime + 15, audioElement.duration);
}

function seekBackward() {
    const audioElement = document.getElementById('audioElement');
    audioElement.currentTime = Math.max(audioElement.currentTime - 15, 0);
}

function seekTo(event) {
    const audioElement = document.getElementById('audioElement');
    const progressBar = event.currentTarget;
    const rect = progressBar.getBoundingClientRect();
    const percent = (event.clientX - rect.left) / rect.width;
    audioElement.currentTime = percent * audioElement.duration;
}

function toggleVolume() {
    const audioElement = document.getElementById('audioElement');
    const volumeIcon = document.getElementById('volumeIcon');
    isMuted = !isMuted;
    audioElement.muted = isMuted;
    volumeIcon.className = isMuted ? 'fas fa-volume-mute' : 'fas fa-volume-up';
}

function downloadPodcast(podcastId) {
    alert('Download feature coming soon! Subscribe to get notified.');
}

function sharePodcast(podcastId) {
    if (navigator.share) {
        navigator.share({
            title: 'Protocol Pulse Podcast',
            text: 'Check out this podcast episode!',
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(window.location.href);
        alert('Link copied to clipboard!');
    }
}

document.getElementById('audioElement').addEventListener('timeupdate', function() {
    const audio = this;
    const progressBar = document.getElementById('progressBar');
    const currentTime = document.getElementById('currentTime');
    const totalTime = document.getElementById('totalTime');
    
    if (audio.duration) {
        const progress = (audio.currentTime / audio.duration) * 100;
        progressBar.style.width = progress + '%';
        
        currentTime.textContent = formatTime(audio.currentTime);
        totalTime.textContent = formatTime(audio.duration);
    }
});

function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return minutes + ':' + (remainingSeconds < 10 ? '0' : '') + remainingSeconds;
}

let loadingStates = {};

function loadMoreEpisodes(sectionName, sectionId) {
    if (loadingStates[sectionId]) return;
    
    loadingStates[sectionId] = true;
    const button = document.getElementById(`see-more-btn-${sectionId}`);
    const container = document.getElementById(`more-episodes-${sectionId}`);
    
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
    button.disabled = true;
    
    const existingEpisodes = container.children.length + 3;
    const loadLimit = button.dataset.showingAll === 'true' ? 999 : 3;
    
    fetch(`/api/podcasts/${encodeURIComponent(sectionName)}?offset=${existingEpisodes}&limit=${loadLimit}`)
        .then(response => response.json())
        .then(data => {
            if (data.podcasts && data.podcasts.length > 0) {
                container.style.display = 'flex';

                data.podcasts.forEach(podcast => {
                    const podcastCard = createPodcastCard(podcast);
                    container.appendChild(podcastCard);
                });
                
                if (button.dataset.showingAll === 'true' || !data.has_more) {
                    button.style.display = 'none';
                } else {
                    button.innerHTML = '<i class="fas fa-expand-alt me-2"></i>See All Episodes';
                    button.dataset.showingAll = 'true';
                }
            } else {
                button.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error loading more episodes:', error);
            button.innerHTML = originalHTML;
            alert('Failed to load more episodes. Please try again.');
        })
        .finally(() => {
            loadingStates[sectionId] = false;
            button.disabled = false;
        });
}

function createPodcastCard(podcast) {
    const col = document.createElement('div');
    col.className = 'col-lg-4 col-md-6';
    
    col.innerHTML = `
        <div class="sovereign-card h-100">
            <div class="podcast-cover-glass">
                ${podcast.cover_image_url ? 
                    `<img src="${podcast.cover_image_url}" alt="${podcast.title}">` :
                    `<div style="width: 100%; height: 200px; background: linear-gradient(135deg, #1a1a1a 0%, #0a0a0a 100%); display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-microphone fa-3x" style="color: var(--pp-red); opacity: 0.4;"></i>
                    </div>`
                }
                <div class="play-overlay-glass">
                    <button class="play-btn-glass" onclick="playPodcast('${podcast.id}')">
                        <i class="fas fa-play"></i>
                    </button>
                </div>
            </div>
            
            <div class="podcast-meta-glass">
                <div class="episode-tag">Episode ${podcast.episode_number || 'N/A'}${podcast.duration ? ' &bull; ' + podcast.duration : ''}</div>
                <h5>${podcast.title}</h5>
                <p class="description">${podcast.description || 'Deep dive into Bitcoin and sovereign finance.'}...</p>
                <div class="podcast-actions">
                    <button class="btn btn-primary btn-sm" onclick="playPodcast('${podcast.id}')">
                        <i class="fas fa-play me-1"></i>Play
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="downloadPodcast('${podcast.id}')">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="sharePodcast('${podcast.id}')">
                        <i class="fas fa-share"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    return col;
}
</script>
{% endblock %}
