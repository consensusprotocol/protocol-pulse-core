{% extends "base.html" %}
{% block title %}Intelligence Dashboard - Protocol Pulse{% endblock %}

{% block schema %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Bitcoin Intelligence Dashboard",
    "description": "Real-time Bitcoin network metrics including difficulty, hashrate, mempool stats, and fee estimates. Live data from Mempool.space for transactors.",
    "mainEntity": {
        "@type": "Dataset",
        "name": "Bitcoin Network Metrics",
        "description": "Live Bitcoin network statistics including difficulty (146.47 T), hashrate (~977 EH/s), mempool size, and recommended fees.",
        "temporalCoverage": "2025/..",
        "license": "https://creativecommons.org/publicdomain/zero/1.0/"
    }
}
</script>
{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    .dashboard-hero {
        background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%);
        padding: 2rem 0;
        border-bottom: 1px solid rgba(220, 38, 38, 0.2);
    }
    .dashboard-title {
        font-family: 'JetBrains Mono', monospace;
        font-size: 2rem;
        color: #fff;
    }
    .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        color: #22c55e;
    }
    .live-dot {
        width: 8px;
        height: 8px;
        background: #22c55e;
        border-radius: 50%;
        animation: blink 1s ease-in-out infinite;
    }
    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }
    
    .back-nav {
        position: fixed;
        top: 80px;
        left: 20px;
        z-index: 1000;
    }
    
    .back-btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: rgba(10, 10, 10, 0.95);
        border: 1px solid rgba(220, 38, 38, 0.3);
        border-radius: 12px;
        padding: 12px 20px;
        color: #fff;
        text-decoration: none;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.85rem;
        backdrop-filter: blur(20px);
        transition: all 0.3s ease;
    }
    
    .back-btn:hover {
        background: rgba(220, 38, 38, 0.2);
        border-color: #dc2626;
        color: #fff;
        transform: translateX(-3px);
    }
    
    .back-btn i {
        color: #dc2626;
    }
</style>
{% endblock %}

{% block content %}
<nav class="back-nav">
    <a href="/" class="back-btn">
        <i class="fas fa-arrow-left"></i>
        <span>Back to Home</span>
    </a>
</nav>

<div class="dashboard-container">
    <!-- Dashboard Hero -->
    <div class="dashboard-hero">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="dashboard-title">
                        <i class="fas fa-chart-area text-danger me-2"></i>INTELLIGENCE DASHBOARD
                    </h1>
                    <p class="text-muted mb-0 font-monospace small">Real-time Bitcoin network metrics for transactors</p>
                </div>
                <div class="live-indicator">
                    <span class="live-dot"></span>
                    LIVE DATA
                </div>
            </div>
        </div>
    </div>

    <div class="container py-4">
        <!-- Primary Metrics Row -->
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">Bitcoin Price</div>
                    <div class="metric-value text-warning" id="dashboard-btc-price">{{ price_service.format_price(prices.bitcoin.price) if prices and prices.bitcoin and prices.bitcoin.price else '$--' }}</div>
                    <div class="metric-change {{ 'positive' if prices and prices.bitcoin and prices.bitcoin.change_24h >= 0 else 'negative' }}" id="dashboard-btc-change">
                        {{ price_service.format_change(prices.bitcoin.change_24h) if prices and prices.bitcoin else '--' }} (24h)
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">Network Difficulty</div>
                    <div class="metric-value text-danger">{{ '%.2f T' % (mempool_data.current_difficulty / 1e12) if mempool_data and mempool_data.current_difficulty else '146.47 T' }}</div>
                    <div class="metric-change {{ 'positive' if mempool_data and mempool_data.difficulty_adjustment and mempool_data.difficulty_adjustment.change_percent >= 0 else 'negative' }}">
                        {% if mempool_data and mempool_data.difficulty_adjustment %}
                            {{ '+%.2f' % mempool_data.difficulty_adjustment.change_percent if mempool_data.difficulty_adjustment.change_percent >= 0 else '%.2f' % mempool_data.difficulty_adjustment.change_percent }}% est.
                        {% else %}
                            +1.2% est.
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">Network Hashrate</div>
                    <div class="metric-value text-info">{{ '%.0f EH/s' % (mempool_data.current_hashrate / 1e18) if mempool_data and mempool_data.current_hashrate else '~977 EH/s' }}</div>
                    <div class="metric-change text-muted">Computational Security</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-label">Mempool Size</div>
                    <div class="metric-value text-success">{{ '{:,}'.format(mempool_data.count) if mempool_data and mempool_data.count else '--' }}</div>
                    <div class="metric-change text-muted">Unconfirmed TXs</div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row g-4 mb-4">
            <div class="col-md-8">
                <div class="chart-container">
                    <div class="chart-title"><i class="fas fa-chart-line me-2"></i>Hashrate History (30 Days)</div>
                    <div style="position: relative; height: 250px; width: 100%;">
                        <canvas id="hashrateChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="chart-container h-100">
                    <div class="chart-title"><i class="fas fa-clock me-2"></i>Difficulty Adjustment</div>
                    {% if mempool_data and mempool_data.difficulty_adjustment %}
                    <div class="text-center py-4">
                        <div style="position: relative; height: 120px; width: 200px; margin: 0 auto;">
                            <canvas id="difficultyGauge"></canvas>
                        </div>
                        <div class="mt-3">
                            <div class="text-muted small">Progress</div>
                            <div class="fs-4 fw-bold text-warning">{{ '%.1f' % mempool_data.difficulty_adjustment.progress }}%</div>
                        </div>
                        <div class="mt-2">
                            <div class="text-muted small">Blocks Remaining</div>
                            <div class="fs-5 fw-bold font-monospace">{{ mempool_data.difficulty_adjustment.remaining_blocks }}</div>
                        </div>
                        <div class="mt-2">
                            <div class="text-muted small">Estimated Change</div>
                            <div class="fs-5 fw-bold {{ 'text-success' if mempool_data.difficulty_adjustment.change_percent >= 0 else 'text-danger' }}">
                                {{ '+%.2f' % mempool_data.difficulty_adjustment.change_percent if mempool_data.difficulty_adjustment.change_percent >= 0 else '%.2f' % mempool_data.difficulty_adjustment.change_percent }}%
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-spinner fa-spin me-2"></i>Loading...
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Bitcoin Lens Analysis -->
        <div class="row g-4">
            <div class="col-12">
                <div class="chart-container">
                    <div class="chart-title"><i class="fas fa-eye me-2"></i>The Bitcoin Lens</div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="p-3">
                                <h5 class="text-danger"><i class="fas fa-shield-alt me-2"></i>Network Security</h5>
                                <p class="text-muted small">
                                    Current difficulty at {{ '%.2f T' % (mempool_data.current_difficulty / 1e12) if mempool_data and mempool_data.current_difficulty else '146.47 T' }} 
                                    represents the computational barrier protecting your transactions. Each hash proves work was done to secure the network.
                                </p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3">
                                <h5 class="text-warning"><i class="fas fa-coins me-2"></i>Mining Economics</h5>
                                <p class="text-muted small">
                                    Fee rates indicate network demand. Higher fees signal more users competing for block space. 
                                    Transactors should batch transactions during low-fee periods for efficiency.
                                </p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3">
                                <h5 class="text-info"><i class="fas fa-balance-scale me-2"></i>Sound Money Signal</h5>
                                <p class="text-muted small">
                                    Unlike fiat monetary policy, Bitcoin's issuance is mathematically predetermined. 
                                    The difficulty adjustment ensures blocks are found every ~10 minutes regardless of hashrate changes.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Hashrate Chart
    const hashrateCtx = document.getElementById('hashrateChart');
    if (hashrateCtx) {
        {% if mempool_data and mempool_data.hashrate_history %}
        const hashrateData = {{ mempool_data.hashrate_history | tojson }};
        const labels = hashrateData.map(d => {
            const date = new Date(d.timestamp * 1000);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        const values = hashrateData.map(d => d.avgHashrate / 1e18);
        {% else %}
        // Fallback: generate last 30 days of dates
        const labels = Array.from({length: 30}, (_, i) => {
            const date = new Date();
            date.setDate(date.getDate() - (29 - i));
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });
        const values = Array.from({length: 30}, () => 900 + Math.random() * 100);
        {% endif %}
        
        new Chart(hashrateCtx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Hashrate (EH/s)',
                    data: values,
                    borderColor: '#dc2626',
                    backgroundColor: 'rgba(220, 38, 38, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255,255,255,0.05)'
                        },
                        ticks: {
                            color: '#666',
                            maxTicksLimit: 10
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(255,255,255,0.05)'
                        },
                        ticks: {
                            color: '#666',
                            callback: function(value) {
                                return value.toFixed(0) + ' EH/s';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Difficulty Gauge
    const gaugeCtx = document.getElementById('difficultyGauge');
    if (gaugeCtx) {
        {% if mempool_data and mempool_data.difficulty_adjustment %}
        const progress = {{ mempool_data.difficulty_adjustment.progress }};
        {% else %}
        const progress = 45;
        {% endif %}
        
        new Chart(gaugeCtx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [progress, 100 - progress],
                    backgroundColor: ['#dc2626', '#1a1a1a'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: '70%',
                rotation: -90,
                circumference: 180,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: false
                    }
                }
            }
        });
    }
});

// Fallback: if Bitcoin price is $--, fetch from CoinGecko so dashboard always shows current price
(function() {
    const priceEl = document.getElementById('dashboard-btc-price');
    const changeEl = document.getElementById('dashboard-btc-change');
    if (!priceEl || priceEl.textContent !== '$--') return;
    fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_24hr_change=true', { method: 'GET' })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var btc = data && data.bitcoin;
            if (btc && btc.usd != null) {
                priceEl.textContent = (btc.usd >= 1000 ? '$' + btc.usd.toLocaleString('en', { maximumFractionDigits: 0 }) : '$' + btc.usd.toFixed(2));
                if (changeEl && btc.usd_24h_change != null) {
                    changeEl.textContent = (btc.usd_24h_change >= 0 ? '+' : '') + btc.usd_24h_change.toFixed(1) + '% (24h)';
                    changeEl.className = 'metric-change ' + (btc.usd_24h_change >= 0 ? 'positive' : 'negative');
                }
            }
        })
        .catch(function() {});
})();
</script>
{% endblock %}
