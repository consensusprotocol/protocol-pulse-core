{% extends "base.html" %}
{% block title %}Partner Reels{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Partner Highlight Reels</h2>
    <button id="buildPartnerReelBtn" class="btn btn-danger">Build Today's Draft Reel</button>
  </div>
  <p class="text-muted">Draft-only workflow. No external publishing is triggered.</p>

  <div id="buildResult" class="mb-3"></div>

  <div class="table-responsive">
    <table class="table table-dark table-striped">
      <thead>
        <tr>
          <th>Date</th>
          <th>Theme</th>
          <th>Status</th>
          <th>Created</th>
          <th>View</th>
        </tr>
      </thead>
      <tbody>
        {% for reel in reels %}
        <tr>
          <td>{{ reel.date }}</td>
          <td>{{ reel.theme or "n/a" }}</td>
          <td><span class="badge bg-secondary">{{ reel.status }}</span></td>
          <td>{{ reel.created_at }}</td>
          <td><a class="btn btn-sm btn-outline-light" href="/admin/video/partner-reels/{{ reel.id }}">Open</a></td>
        </tr>
        {% else %}
        <tr><td colspan="5">No reels yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
(function () {
  const btn = document.getElementById('buildPartnerReelBtn');
  const out = document.getElementById('buildResult');
  if (!btn) return;
  btn.addEventListener('click', function () {
    btn.disabled = true;
    out.innerHTML = '<div class="alert alert-dark">building draft partner reel...</div>';
    const csrf = document.querySelector('meta[name="csrf-token"]')?.content || '';
    fetch('/admin/video/partner-reel-build', {
      method: 'POST',
      headers: {'X-CSRF-Token': csrf}
    })
      .then(r => r.json().then(j => ({ok: r.ok, data: j})))
      .then(({ok, data}) => {
        if (!ok || !data.success) {
          out.innerHTML = '<div class="alert alert-warning">build failed: ' + (data.error || 'unknown') + '</div>';
          return;
        }
        out.innerHTML =
          '<div class="alert alert-success">draft reel #' + data.reel_id +
          ' built with ' + data.segments_count + ' segments. ' +
          '<a href="/admin/video/partner-reels/' + data.reel_id + '">open reel</a></div>';
      })
      .catch(() => {
        out.innerHTML = '<div class="alert alert-danger">build request failed.</div>';
      })
      .finally(() => { btn.disabled = false; });
  });
})();
</script>
{% endblock %}

