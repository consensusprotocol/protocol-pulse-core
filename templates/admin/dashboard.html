{% extends "base.html" %}

{% block title %}Admin Dashboard - Protocol Pulse{% endblock %}

{% block content %}
<style>
    @media (max-width: 991.98px) {
        .admin-sidebar {
            position: fixed;
            top: 56px;
            left: -280px;
            width: 280px;
            height: calc(100vh - 56px);
            background: #1a1a2e;
            z-index: 1040;
            transition: left 0.3s ease;
            overflow-y: auto;
            padding: 1rem;
        }
        .admin-sidebar.show {
            left: 0;
        }
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 56px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1035;
        }
        .sidebar-overlay.show {
            display: block;
        }
        .admin-toggle-btn {
            display: block !important;
        }
    }
    @media (min-width: 992px) {
        .admin-toggle-btn {
            display: none !important;
        }
    }
</style>

<div class="container-fluid mt-5 pt-4">
    <!-- Mobile Toggle Button -->
    <button class="btn btn-primary mb-3 admin-toggle-btn d-lg-none" type="button" id="adminSidebarToggle">
        <i class="fas fa-bars me-2"></i> Menu
    </button>
    
    <!-- Overlay for mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-2 admin-sidebar" id="adminSidebar">
            <div class="position-sticky pt-3">
                <h5 class="text-primary mb-3">
                    <i class="fas fa-cogs"></i> Admin Panel
                </h5>
                <ul class="nav nav-pills flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin">
                            <i class="fas fa-tachometer-alt"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/write">
                            <i class="fas fa-pen"></i> Write Article
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/generate">
                            <i class="fas fa-robot"></i> AI Generate
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/ads">
                            <i class="fas fa-ad"></i> Manage Ads
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/articles">
                            <i class="fas fa-newspaper"></i> View Articles
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/podcasts">
                            <i class="fas fa-podcast"></i> View Podcasts
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-10">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
                <h1 class="h2 text-white">
                    <i class="fas fa-broadcast-tower text-primary"></i> 
                    Protocol Pulse Dashboard
                </h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <button type="button" class="btn btn-primary" onclick="location.href='/admin/generate'">
                            <i class="fas fa-plus"></i> Generate Content
                        </button>
                        <button type="button" class="btn btn-outline-light" onclick="refreshTrends()">
                            <i class="fas fa-sync"></i> Refresh Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-primary shadow h-100 py-2 bg-dark border-primary">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                        Total Articles
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-white">{{ total_articles }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-newspaper fa-2x text-primary"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-success shadow h-100 py-2 bg-dark border-success">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                        Published Articles
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-white">{{ published_articles }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-check-circle fa-2x text-success"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-info shadow h-100 py-2 bg-dark border-info">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                        Total Podcasts
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-white">{{ total_podcasts }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-podcast fa-2x text-info"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-xl-3 col-md-6 mb-4">
                    <div class="card border-left-warning shadow h-100 py-2 bg-dark border-warning">
                        <div class="card-body">
                            <div class="row no-gutters align-items-center">
                                <div class="col mr-2">
                                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                        Draft Articles
                                    </div>
                                    <div class="h5 mb-0 font-weight-bold text-white">{{ total_articles - published_articles }}</div>
                                </div>
                                <div class="col-auto">
                                    <i class="fas fa-edit fa-2x text-warning"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card bg-dark border-primary">
                        <div class="card-header border-primary">
                            <h5 class="text-primary mb-0">
                                <i class="fas fa-rocket"></i> Quick Actions
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="quickTopic" class="form-label text-light">Generate New Article:</label>
                                    <div class="input-group mb-3">
                                        <input type="text" class="form-control bg-dark text-light border-primary" 
                                               id="quickTopic" placeholder="Bitcoin Lightning Network updates...">
                                        <button class="btn btn-primary" type="button" onclick="quickGenerate()">
                                            <i class="fas fa-magic"></i> Generate
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-light">Content Type:</label>
                                    <select id="contentType" class="form-select bg-dark text-light border-primary">
                                        <option value="bitcoin_news">Bitcoin News</option>
                                        <option value="defi_analysis">DeFi Analysis</option>
                                        <option value="breaking_news">Breaking News</option>
                                        <option value="market_update">Market Update</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Articles -->
            <div class="row">
                <div class="col-12">
                    <div class="card bg-dark border-primary">
                        <div class="card-header border-primary">
                            <h5 class="text-primary mb-0">
                                <i class="fas fa-clock"></i> Recent Articles
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if recent_articles %}
                                <div class="table-responsive">
                                    <table class="table table-dark table-striped">
                                        <thead>
                                            <tr>
                                                <th>Title</th>
                                                <th>Category</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for article in recent_articles %}
                                            <tr>
                                                <td>
                                                    <a href="/articles/{{ article.id }}" class="text-primary text-decoration-none">
                                                        {{ article.title[:60] }}{% if article.title|length > 60 %}...{% endif %}
                                                    </a>
                                                </td>
                                                <td>
                                                    <span class="badge bg-secondary">{{ article.category }}</span>
                                                </td>
                                                <td>
                                                    {% if article.published %}
                                                        <span class="badge bg-success">Published</span>
                                                    {% else %}
                                                        <span class="badge bg-warning">Draft</span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-muted">
                                                    {{ article.created_at.strftime('%b %d, %Y') }}
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        <a href="/admin/edit/{{ article.id }}" class="btn btn-outline-primary btn-sm" title="Edit Article">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        {% if not article.published %}
                                                            <button class="btn btn-outline-success btn-sm" 
                                                                    onclick="publishArticle({{ article.id }})" 
                                                                    title="Publish Article">
                                                                <i class="fas fa-check"></i>
                                                            </button>
                                                        {% endif %}
                                                        {% if article.published and not article.substack_url %}
                                                            <button class="btn btn-outline-info btn-sm" 
                                                                    onclick="publishToSubstack({{ article.id }})" 
                                                                    title="Publish to Substack">
                                                                <i class="fas fa-paper-plane"></i>
                                                            </button>
                                                        {% endif %}
                                                        {% if article.substack_url %}
                                                            <button class="btn btn-outline-warning btn-sm" 
                                                                    onclick="shareToReddit({{ article.id }})" 
                                                                    title="Share to Reddit">
                                                                <i class="fab fa-reddit"></i>
                                                            </button>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No articles found. Generate your first article!</p>
                                    <button class="btn btn-primary" onclick="location.href='/admin/generate'">
                                        <i class="fas fa-plus"></i> Generate Article
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.sidebar {
    position: fixed;
    top: 80px;
    bottom: 0;
    left: 0;
    z-index: 100;
    padding: 48px 0 0;
    box-shadow: inset -1px 0 0 rgba(0, 123, 255, .1);
    background: rgba(13, 27, 42, 0.9);
    backdrop-filter: blur(10px);
}

.sidebar .nav-link {
    color: #adb5bd;
    padding: 12px 16px;
    margin: 4px 8px;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.sidebar .nav-link:hover,
.sidebar .nav-link.active {
    color: #007bff;
    background: rgba(0, 123, 255, 0.1);
    transform: translateX(5px);
}

.border-left-primary { border-left: 4px solid #007bff !important; }
.border-left-success { border-left: 4px solid #28a745 !important; }
.border-left-info { border-left: 4px solid #17a2b8 !important; }
.border-left-warning { border-left: 4px solid #ffc107 !important; }

.card { 
    transition: all 0.3s ease; 
    border: 1px solid rgba(0, 123, 255, 0.2);
}
.card:hover { 
    transform: translateY(-2px); 
    box-shadow: 0 8px 25px rgba(0, 123, 255, 0.2);
}

@media (max-width: 767.98px) {
    .sidebar {
        position: relative;
        top: 0;
        height: auto;
    }
}
</style>

<script>
async function quickGenerate() {
    const topic = document.getElementById('quickTopic').value;
    const contentType = document.getElementById('contentType').value;
    
    if (!topic) {
        alert('Please enter a topic for the article');
        return;
    }
    
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    button.disabled = true;
    
    try {
        const response = await fetch('/api/generate-article', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                topic: topic,
                source_type: 'ai_generated'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Article generated successfully!');
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error generating article: ' + error.message);
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

async function publishArticle(id) {
    if (!confirm('Publish this article?')) return;
    
    try {
        const response = await fetch(`/api/publish-article/${id}`, {method: 'POST'});
        const result = await response.json();
        
        if (result.success) {
            alert('Article published successfully!');
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function publishToSubstack(id) {
    if (!confirm('Publish this article to Substack?')) return;
    
    try {
        const response = await fetch(`/admin/publish-to-substack/${id}`, {method: 'POST'});
        const result = await response.json();
        
        if (result.success) {
            alert('Article published to Substack successfully!');
            location.reload();
        } else {
            alert('Error: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function shareToReddit(id) {
    const subreddit = prompt('Enter subreddit name (default: bitcoin):', 'bitcoin');
    if (!subreddit) return;
    
    try {
        const response = await fetch(`/admin/share-reddit/${id}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({subreddit: subreddit})
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Article shared to Reddit successfully!');
        } else {
            alert('Error: ' + (result.error || result.message || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function refreshTrends() {
    location.reload();
}

// Admin sidebar toggle for mobile
document.addEventListener('DOMContentLoaded', function() {
    var sidebar = document.getElementById('adminSidebar');
    var overlay = document.getElementById('sidebarOverlay');
    var toggleBtn = document.getElementById('adminSidebarToggle');
    
    if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        });
    }
    
    if (overlay) {
        overlay.addEventListener('click', function() {
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
        });
    }
    
    // Close sidebar when clicking a link on mobile
    var sidebarLinks = sidebar.querySelectorAll('.nav-link');
    sidebarLinks.forEach(function(link) {
        link.addEventListener('click', function() {
            if (window.innerWidth < 992) {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
            }
        });
    });
});
</script>

{% endblock %}