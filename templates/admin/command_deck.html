{% extends "base.html" %}

{% block title %}Command Deck - Protocol Pulse{% endblock %}

{% block extra_css %}
<style>
.command-deck {
    min-height: 100vh;
    background: linear-gradient(135deg, #0a0a0a 0%, #1a0808 100%);
    padding: 40px 20px;
}

.deck-header {
    text-align: center;
    margin-bottom: 40px;
}

.deck-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 2rem;
    color: var(--pp-red);
    text-transform: uppercase;
    letter-spacing: 0.2em;
}

.deck-subtitle {
    color: rgba(255,255,255,0.5);
    font-size: 0.9rem;
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.status-card {
    background: rgba(10, 10, 10, 0.9);
    border: 1px solid rgba(220, 38, 38, 0.3);
    border-radius: 12px;
    padding: 25px;
    backdrop-filter: blur(10px);
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.card-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    color: rgba(255,255,255,0.8);
    text-transform: uppercase;
    letter-spacing: 0.1em;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    text-transform: uppercase;
}

.status-online {
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    border: 1px solid rgba(34, 197, 94, 0.3);
}

.status-offline {
    background: rgba(220, 38, 38, 0.2);
    color: #dc2626;
    border: 1px solid rgba(220, 38, 38, 0.3);
}

.status-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}

.status-label {
    color: rgba(255,255,255,0.5);
    font-size: 0.85rem;
}

.status-value {
    color: white;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
}

.action-btn {
    width: 100%;
    padding: 12px;
    margin-top: 15px;
    background: linear-gradient(135deg, var(--pp-red), #8b0000);
    border: none;
    border-radius: 8px;
    color: white;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(220, 38, 38, 0.3);
}

.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.empire-status {
    text-align: center;
    padding: 30px;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
    border: 1px solid rgba(34, 197, 94, 0.3);
    border-radius: 12px;
    margin-bottom: 30px;
}

.empire-badge {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.5rem;
    color: #22c55e;
    text-transform: uppercase;
    letter-spacing: 0.3em;
}

.log-output {
    background: #000;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 15px;
    margin-top: 15px;
    max-height: 200px;
    overflow-y: auto;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: #22c55e;
}
</style>
{% endblock %}

{% block content %}
<div class="command-deck">
    <div class="container">
        <div class="deck-header">
            <h1 class="deck-title"><i class="fas fa-terminal me-3"></i>Sovereign Command Deck</h1>
            <p class="deck-subtitle">System Control & Dispatch Center</p>
        </div>
        
        <div class="empire-status">
            <div class="empire-badge" id="empireStatus">
                <i class="fas fa-crown me-2"></i>[SYSTEM STATUS: EMPIRE READY]
            </div>
        </div>
        
        <div class="status-grid">
            <!-- Scheduler Status -->
            <div class="status-card">
                <div class="card-header">
                    <span class="card-title"><i class="fas fa-clock me-2"></i>Scheduler</span>
                    <span class="status-badge {% if scheduler_status.running %}status-online{% else %}status-offline{% endif %}">
                        {% if scheduler_status.running %}ACTIVE{% else %}STOPPED{% endif %}
                    </span>
                </div>
                
                <div class="status-row">
                    <span class="status-label">Cypherpunk'd Loop</span>
                    <span class="status-value">Every 6 Hours</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Social Guard</span>
                    <span class="status-value">Every 10 Minutes</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Active Jobs</span>
                    <span class="status-value">{{ scheduler_status.jobs|length if scheduler_status.jobs else 0 }}</span>
                </div>
                
                <button class="action-btn" onclick="activateScheduler()">
                    <i class="fas fa-play me-2"></i>Activate Scheduler
                </button>
            </div>
            
            <!-- Telegram Status -->
            <div class="status-card">
                <div class="card-header">
                    <span class="card-title"><i class="fab fa-telegram me-2"></i>Pulse Operative</span>
                    <span class="status-badge {% if telegram_status.initialized %}status-online{% else %}status-offline{% endif %}">
                        {% if telegram_status.initialized %}CONNECTED{% else %}OFFLINE{% endif %}
                    </span>
                </div>
                
                <div class="status-row">
                    <span class="status-label">Bot Token</span>
                    <span class="status-value">{% if telegram_status.token_configured %}Configured{% else %}Missing{% endif %}</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Chat ID</span>
                    <span class="status-value">{% if telegram_status.channel_configured %}Configured{% else %}Missing{% endif %}</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Status</span>
                    <span class="status-value">{% if telegram_status.bot_running %}Running{% else %}Standby{% endif %}</span>
                </div>
                
                <button class="action-btn" onclick="sendHeartbeat()">
                    <i class="fas fa-heartbeat me-2"></i>Send Heartbeat
                </button>
            </div>
            
            <!-- Sponsorship Deck -->
            <div class="status-card" style="border-color: rgba(220, 38, 38, 0.4);">
                <div class="card-header">
                    <span class="card-title" style="color: #dc2626;"><i class="fas fa-chart-line me-2"></i>Sponsorship Deck</span>
                    <span class="status-badge status-online">LIVE</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Real-Time Metrics</span>
                    <span class="status-value">Views ¬∑ Visits ¬∑ Impressions</span>
                </div>
                <a href="/admin/deck" class="action-btn" style="display: block; text-align: center; text-decoration: none;">
                    <i class="fas fa-file-pdf me-2"></i>View Sponsorship Metrics
                </a>
            </div>

            <!-- Zero Hour Audit -->
            <div class="status-card" style="border-color: rgba(34, 197, 94, 0.4);">
                <div class="card-header">
                    <span class="card-title" style="color: #22c55e;"><i class="fas fa-check-double me-2"></i>Zero Hour Audit</span>
                    <span class="status-badge" id="auditBadge" style="background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.3);">READY</span>
                </div>
                
                <div class="status-row">
                    <span class="status-label">Database</span>
                    <span class="status-value" id="auditDb">--</span>
                </div>
                <div class="status-row">
                    <span class="status-label">GHL CRM</span>
                    <span class="status-value" id="auditGhl">--</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Telegram</span>
                    <span class="status-value" id="auditTelegram">--</span>
                </div>
                
                <button class="action-btn" onclick="runZeroHourAudit()" style="background: linear-gradient(135deg, #166534, #22c55e);">
                    <i class="fas fa-satellite-dish me-2"></i>Run Full Audit
                </button>
            </div>
            
            <!-- Whale Intelligence -->
            <div class="status-card">
                <div class="card-header">
                    <span class="card-title"><i class="fas fa-whale me-2"></i>Whale Intelligence</span>
                    <span class="status-badge status-online">MONITORING</span>
                </div>
                
                <div class="status-row">
                    <span class="status-label">Mega-Whale Threshold</span>
                    <span class="status-value">1,000+ BTC</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Alert Channels</span>
                    <span class="status-value">Nostr, X, Telegram</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Auto-Dispatch</span>
                    <span class="status-value">Enabled</span>
                </div>
                
                <button class="action-btn" onclick="checkWhales()">
                    <i class="fas fa-search me-2"></i>Check for Whales
                </button>
            </div>
            
            <!-- Privacy Shield -->
            <div class="status-card" style="border-color: rgba(168, 85, 247, 0.4);">
                <div class="card-header">
                    <span class="card-title" style="color: #a855f7;"><i class="fas fa-shield-alt me-2"></i>Privacy Shield</span>
                    <span class="status-badge" id="privacyShieldBadge" style="background: rgba(168, 85, 247, 0.2); color: #a855f7; border: 1px solid rgba(168, 85, 247, 0.3);">CHECKING...</span>
                </div>
                
                <div class="status-row">
                    <span class="status-label">Tracker Blocking</span>
                    <span class="status-value" id="trackerStatus">Initializing</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Identity Masking</span>
                    <span class="status-value" id="identityStatus">Initializing</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Purple Hue</span>
                    <span class="status-value" id="purpleStatus">Initializing</span>
                </div>
                
                <button class="action-btn" onclick="togglePrivacyShield()" style="background: linear-gradient(135deg, #6b21a8, #a855f7);">
                    <i class="fas fa-shield-alt me-2"></i>Toggle Privacy Shield
                </button>
            </div>
            
            <!-- Multi-Agent System -->
            <div class="status-card">
                <div class="card-header">
                    <span class="card-title"><i class="fas fa-robot me-2"></i>Multi-Agent System</span>
                    <span class="status-badge status-online">OPERATIONAL</span>
                </div>
                
                <div class="status-row">
                    <span class="status-label">Alex The Quant</span>
                    <span class="status-value">Ready</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Sarah The Macro</span>
                    <span class="status-value">Ready</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Walter Cronkite</span>
                    <span class="status-value">Ready</span>
                </div>
                
                <button class="action-btn" onclick="testAgents()">
                    <i class="fas fa-vial me-2"></i>Test Agents
                </button>
            </div>
            
            <!-- GHL Handshake -->
            <div class="status-card" style="border-color: rgba(34, 197, 94, 0.4);">
                <div class="card-header">
                    <span class="card-title" style="color: #22c55e;"><i class="fas fa-handshake me-2"></i>GHL Handshake</span>
                    <span class="status-badge" id="ghlStatusBadge" style="background: rgba(34, 197, 94, 0.2); color: #22c55e;">CHECKING...</span>
                </div>
                
                <div class="status-row">
                    <span class="status-label">API Connection</span>
                    <span class="status-value" id="ghlApiStatus">Verifying...</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Operative Onboarding</span>
                    <span class="status-value">Webhook Ready</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Custom Fields</span>
                    <span class="status-value">signal_points, sovereign_segment</span>
                </div>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="action-btn" onclick="testGHLWebhook()" style="flex: 1; background: linear-gradient(135deg, #059669, #22c55e);">
                        <i class="fas fa-satellite-dish me-2"></i>Send Test Payload
                    </button>
                    <button class="action-btn" onclick="triggerSarahWelcome()" style="flex: 1;">
                        <i class="fas fa-envelope me-2"></i>Sarah Welcome
                    </button>
                </div>
            </div>
            
            <!-- Sovereign SMS Dispatch -->
            <div class="status-card" style="border-color: rgba(251, 146, 60, 0.4);">
                <div class="card-header">
                    <span class="card-title" style="color: #fb923c;"><i class="fas fa-sms me-2"></i>Sovereign SMS</span>
                    <span class="status-badge" style="background: rgba(251, 146, 60, 0.2); color: #fb923c;">98% OPEN RATE</span>
                </div>
                
                <div class="status-row">
                    <span class="status-label">Mega-Whale Alerts</span>
                    <span class="status-value">&gt;1,000 BTC Threshold</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Target Segments</span>
                    <span class="status-value">Sovereign Node, Institutional</span>
                </div>
                <div class="status-row">
                    <span class="status-label">Compliance</span>
                    <span class="status-value">STOP Keyword Included</span>
                </div>
                
                <div style="margin-bottom: 10px;">
                    <input type="tel" id="testPhoneNumber" placeholder="Your phone number (+1XXXXXXXXXX)" 
                           style="width: 100%; padding: 10px; background: rgba(0,0,0,0.5); border: 1px solid rgba(251, 146, 60, 0.3); color: #fff; border-radius: 8px;">
                </div>
                <button class="action-btn" onclick="sendSMSTestPulse()" style="background: linear-gradient(135deg, #ea580c, #fb923c);">
                    <i class="fas fa-mobile-alt me-2"></i>SMS Test Pulse
                </button>
            </div>
        </div>
        
        <div class="status-card mt-4" style="max-width: 1200px; margin: 20px auto;">
            <div class="card-header">
                <span class="card-title"><i class="fas fa-terminal me-2"></i>System Log</span>
                <span class="status-badge status-online">LIVE</span>
            </div>
            <div class="log-output" id="logOutput">
                [{{ (deck_time.strftime('%Y-%m-%d %H:%M:%S') if deck_time is defined else '') }}] Command Deck initialized
                [{{ (deck_time.strftime('%Y-%m-%d %H:%M:%S') if deck_time is defined else '') }}] Awaiting operator commands...
            </div>
        </div>
    </div>
</div>

<script>
function log(message) {
    const logOutput = document.getElementById('logOutput');
    const timestamp = new Date().toISOString().slice(0, 19).replace('T', ' ');
    logOutput.innerHTML += `\n[${timestamp}] ${message}`;
    logOutput.scrollTop = logOutput.scrollHeight;
}

async function activateScheduler() {
    log('Activating scheduler...');
    try {
        const response = await fetch('/admin/api/activate-scheduler', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            log('SCHEDULER ACTIVATED - Cypherpunk\'d loop and Social Guard online');
        } else {
            log('ERROR: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        log('ERROR: ' + e.message);
    }
}

async function sendHeartbeat() {
    log('Sending EMPIRE READY heartbeat to Telegram...');
    try {
        const response = await fetch('/admin/api/send-heartbeat', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            log('HEARTBEAT SENT - Pulse Operative confirmed');
        } else {
            log('HEARTBEAT FAILED: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        log('ERROR: ' + e.message);
    }
}

async function checkWhales() {
    log('Scanning for mega-whales (1000+ BTC)...');
    try {
        const response = await fetch('/api/whales/live');
        const data = await response.json();
        const count = (data && data.whales && data.whales.length) || 0;
        log(`Whale scan complete - ${count} transactions detected`);
    } catch (e) {
        log('ERROR: ' + e.message);
    }
}

async function testAgents() {
    log('Testing multi-agent system...');
    log('Alex The Quant: READY');
    log('Sarah The Macro: READY');
    log('Walter Cronkite: READY');
    log('All agents operational');
}

function togglePrivacyShield() {
    const isEnabled = localStorage.getItem('sovereignMode') === 'true';
    localStorage.setItem('sovereignMode', (!isEnabled).toString());
    
    if (!isEnabled) {
        document.body.classList.add('sovereign-active');
        log('PRIVACY SHIELD ACTIVATED - Purple hue engaged, trackers blocked');
        alert('Sovereign Mode Engaged: CDNs Blocked. Identity Masked.');
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({ type: 'SOVEREIGN_MODE', enabled: true });
        }
    } else {
        document.body.classList.remove('sovereign-active');
        log('Privacy Shield deactivated - Standard mode restored');
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({ type: 'SOVEREIGN_MODE', enabled: false });
        }
    }
    updatePrivacyStatus();
}

function updatePrivacyStatus() {
    const isEnabled = localStorage.getItem('sovereignMode') === 'true';
    const badge = document.getElementById('privacyShieldBadge');
    const trackerEl = document.getElementById('trackerStatus');
    const identityEl = document.getElementById('identityStatus');
    const purpleEl = document.getElementById('purpleStatus');
    
    if (isEnabled) {
        badge.textContent = 'ACTIVE';
        badge.style.background = 'rgba(34, 197, 94, 0.2)';
        badge.style.color = '#22c55e';
        badge.style.borderColor = 'rgba(34, 197, 94, 0.3)';
        trackerEl.innerHTML = '<span style="color: #22c55e;">üö´ BLOCKED</span>';
        identityEl.innerHTML = '<span style="color: #22c55e;">üïµÔ∏è MASKED</span>';
        purpleEl.innerHTML = '<span style="color: #a855f7;">üü£ ENGAGED</span>';
    } else {
        badge.textContent = 'INACTIVE';
        badge.style.background = 'rgba(168, 85, 247, 0.2)';
        badge.style.color = '#a855f7';
        badge.style.borderColor = 'rgba(168, 85, 247, 0.3)';
        trackerEl.textContent = 'Disabled';
        identityEl.textContent = 'Disabled';
        purpleEl.textContent = 'Disabled';
    }
}

function now() {
    return new Date();
}

async function testGHLWebhook() {
    log('Sending test payload to GHL...');
    log('Payload: { first_name: "Test Operative", signal_points: 750, sovereign_segment: "Sovereign Node" }');
    try {
        const response = await fetch('/admin/api/ghl-webhook-test', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            log('GHL WEBHOOK SUCCESS: ' + data.message);
            log('Status Code: ' + data.status_code + ' OK');
            updateGHLStatus(true);
        } else {
            log('GHL WEBHOOK FAILED: ' + (data.error || 'Unknown error'));
            updateGHLStatus(false);
        }
    } catch (e) {
        log('ERROR: ' + e.message);
        updateGHLStatus(false);
    }
}

async function triggerSarahWelcome() {
    log('Triggering Sarah Welcome emails to recent Scorecard completers...');
    try {
        const response = await fetch('/admin/api/sarah-welcome', { method: 'POST' });
        const data = await response.json();
        if (data.success) {
            log('SARAH WELCOME: Triggered ' + data.triggered_count + ' emails');
            log('Total Scorecard contacts: ' + data.total_scorecard_contacts);
        } else {
            log('SARAH WELCOME FAILED: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        log('ERROR: ' + e.message);
    }
}

async function sendSMSTestPulse() {
    const phoneInput = document.getElementById('testPhoneNumber');
    const phoneNumber = phoneInput?.value?.trim();
    
    if (!phoneNumber) {
        log('ERROR: Please enter your phone number for SMS test');
        alert('Please enter your phone number in the field above.');
        return;
    }
    
    log('Sending SMS Test Pulse to ' + phoneNumber + '...');
    try {
        const response = await fetch('/admin/api/sms-test-pulse', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone_number: phoneNumber })
        });
        const data = await response.json();
        if (data.success) {
            log('SMS TEST PULSE SENT: Check your phone!');
            alert('SMS Test Pulse sent! Check your phone.');
        } else {
            log('SMS FAILED: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        log('ERROR: ' + e.message);
    }
}

function updateGHLStatus(connected) {
    const badge = document.getElementById('ghlStatusBadge');
    const apiStatus = document.getElementById('ghlApiStatus');
    
    if (connected) {
        badge.textContent = 'CONNECTED';
        badge.style.background = 'rgba(34, 197, 94, 0.2)';
        badge.style.color = '#22c55e';
        apiStatus.innerHTML = '<span style="color: #22c55e;">200 OK</span>';
    } else {
        badge.textContent = 'ERROR';
        badge.style.background = 'rgba(239, 68, 68, 0.2)';
        badge.style.color = '#ef4444';
        apiStatus.innerHTML = '<span style="color: #ef4444;">Connection Failed</span>';
    }
}

async function verifyGHLConnection() {
    try {
        const response = await fetch('/admin/api/ghl-verify');
        const data = await response.json();
        updateGHLStatus(data.success);
        if (data.success) {
            log('GHL API VERIFIED: Connected to ' + (data.location_name || 'Location'));
        }
    } catch (e) {
        updateGHLStatus(false);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    updatePrivacyStatus();
    if (localStorage.getItem('sovereignMode') === 'true') {
        document.body.classList.add('sovereign-active');
    }
    verifyGHLConnection();
});

async function runZeroHourAudit() {
    log('ZERO HOUR AUDIT: Initiating system check...');
    document.getElementById('auditBadge').textContent = 'CHECKING...';
    
    try {
        const response = await fetch('/admin/api/zero-hour-audit');
        const data = await response.json();
        
        document.getElementById('auditDb').innerHTML = 
            data.database.status === 'ONLINE' 
                ? '<span style="color: #22c55e;">ONLINE</span>' 
                : '<span style="color: #ef4444;">' + data.database.status + '</span>';
        
        document.getElementById('auditGhl').innerHTML = 
            data.ghl.status === 'ONLINE' 
                ? '<span style="color: #22c55e;">ONLINE</span>' 
                : '<span style="color: #f97316;">' + data.ghl.status + '</span>';
        
        document.getElementById('auditTelegram').innerHTML = 
            data.telegram.status === 'ONLINE' 
                ? '<span style="color: #22c55e;">ONLINE</span>' 
                : '<span style="color: #f97316;">' + data.telegram.status + '</span>';
        
        if (data.overall === 'EMPIRE READY') {
            document.getElementById('auditBadge').textContent = 'EMPIRE READY';
            document.getElementById('auditBadge').style.background = 'rgba(34, 197, 94, 0.2)';
            document.getElementById('auditBadge').style.color = '#22c55e';
            log('SYSTEM STATUS: EMPIRE READY - All systems operational');
        } else {
            document.getElementById('auditBadge').textContent = 'DEGRADED';
            document.getElementById('auditBadge').style.background = 'rgba(249, 115, 22, 0.2)';
            document.getElementById('auditBadge').style.color = '#f97316';
            log('SYSTEM STATUS: DEGRADED - Some systems need attention');
        }
        
        log('Database: ' + data.database.message);
        log('GHL: ' + data.ghl.message);
        log('Telegram: ' + data.telegram.message);
        
    } catch (e) {
        log('AUDIT ERROR: ' + e.message);
        document.getElementById('auditBadge').textContent = 'ERROR';
        document.getElementById('auditBadge').style.background = 'rgba(239, 68, 68, 0.2)';
        document.getElementById('auditBadge').style.color = '#ef4444';
    }
}

log('Day 1 - Empire awakens. Intelligence flows.');
</script>
{% endblock %}
