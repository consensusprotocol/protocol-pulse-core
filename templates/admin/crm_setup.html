{% extends 'admin/base.html' %}

{% block title %}HighPoint CRM Setup - Protocol Pulse{% endblock %}

{% block extra_css %}
<style>
    .crm-wizard {
        background: linear-gradient(135deg, rgba(30, 20, 40, 0.95), rgba(20, 15, 30, 0.98));
        border: 1px solid rgba(138, 43, 226, 0.3);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .sarah-guidance {
        background: linear-gradient(135deg, rgba(138, 43, 226, 0.15), rgba(75, 0, 130, 0.1));
        border-left: 3px solid #8a2be2;
        padding: 1.25rem;
        margin-bottom: 2rem;
        border-radius: 0 8px 8px 0;
        font-style: italic;
        color: #c9a0ff;
    }
    
    .sarah-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #8a2be2, #4b0082);
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-weight: bold;
        color: white;
        font-size: 1.1rem;
    }
    
    .setup-step {
        background: rgba(20, 15, 30, 0.8);
        border: 1px solid rgba(138, 43, 226, 0.2);
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .setup-step.completed {
        border-color: #28a745;
        background: rgba(40, 167, 69, 0.1);
    }
    
    .setup-step.active {
        border-color: #8a2be2;
        box-shadow: 0 0 20px rgba(138, 43, 226, 0.3);
    }
    
    .step-number {
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #8a2be2, #4b0082);
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        margin-right: 12px;
    }
    
    .step-number.completed {
        background: linear-gradient(135deg, #28a745, #1e7e34);
    }
    
    .step-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #f5f5f5;
        margin-bottom: 0.5rem;
    }
    
    .step-instructions {
        color: #aaa;
        margin-bottom: 1rem;
    }
    
    .api-key-form {
        background: rgba(0, 0, 0, 0.3);
        padding: 1.5rem;
        border-radius: 8px;
        margin-top: 1rem;
    }
    
    .form-control-dark {
        background: rgba(30, 25, 45, 0.9);
        border: 1px solid rgba(138, 43, 226, 0.3);
        color: #f5f5f5;
        padding: 12px 16px;
        border-radius: 6px;
    }
    
    .form-control-dark:focus {
        background: rgba(40, 35, 55, 0.95);
        border-color: #8a2be2;
        box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.2);
        color: #fff;
    }
    
    .form-control-dark::placeholder {
        color: #666;
    }
    
    .btn-sovereign {
        background: linear-gradient(135deg, #8a2be2, #4b0082);
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 6px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-sovereign:hover {
        background: linear-gradient(135deg, #9b4de3, #5c1493);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(138, 43, 226, 0.4);
        color: white;
    }
    
    .btn-test {
        background: rgba(138, 43, 226, 0.2);
        border: 1px solid #8a2be2;
        color: #c9a0ff;
    }
    
    .btn-test:hover {
        background: rgba(138, 43, 226, 0.3);
        color: white;
    }
    
    .connection-status {
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        display: none;
    }
    
    .connection-status.success {
        display: block;
        background: rgba(40, 167, 69, 0.2);
        border: 1px solid #28a745;
        color: #7ddf8c;
    }
    
    .connection-status.error {
        display: block;
        background: rgba(220, 53, 69, 0.2);
        border: 1px solid #dc3545;
        color: #f5a5ab;
    }
    
    .webhook-url {
        background: rgba(0, 0, 0, 0.5);
        padding: 12px 16px;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        color: #8a2be2;
        word-break: break-all;
        margin: 1rem 0;
    }
    
    .copy-btn {
        background: transparent;
        border: 1px solid #8a2be2;
        color: #8a2be2;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .copy-btn:hover {
        background: rgba(138, 43, 226, 0.2);
    }
    
    .progress-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
        padding: 0 1rem;
    }
    
    .progress-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: rgba(138, 43, 226, 0.3);
        position: relative;
    }
    
    .progress-dot.completed {
        background: #28a745;
    }
    
    .progress-dot.active {
        background: #8a2be2;
        box-shadow: 0 0 10px #8a2be2;
    }
    
    .progress-line {
        flex: 1;
        height: 2px;
        background: rgba(138, 43, 226, 0.2);
        margin: 5px 8px;
    }
    
    .progress-line.completed {
        background: #28a745;
    }
    
    .tag-example {
        background: linear-gradient(135deg, #8a2be2, #4b0082);
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
        display: inline-block;
        margin: 2px;
    }
    
    .diagnostic-panel {
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(138, 43, 226, 0.2);
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 2rem;
    }
    
    .diagnostic-item {
        display: flex;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .diagnostic-item:last-child {
        border-bottom: none;
    }
    
    .diagnostic-icon {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-size: 0.75rem;
    }
    
    .diagnostic-icon.pending {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
    }
    
    .diagnostic-icon.success {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
    }
    
    .diagnostic-icon.error {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4" style="color: #f5f5f5;">
                <i class="fas fa-satellite-dish me-2" style="color: #8a2be2;"></i>
                HighPoint CRM Setup Wizard
            </h2>
            
            <div class="sarah-guidance">
                <span class="sarah-avatar">S</span>
                <strong>SARAH (The Macro):</strong> "Operative, establish the link to the HighPoint node. Accuracy is paramount for data synchronization. Follow each step precisely—the integrity of our intelligence network depends on it."
            </div>
            
            <div class="progress-indicator">
                <div class="progress-dot" id="dot-1"></div>
                <div class="progress-line" id="line-1"></div>
                <div class="progress-dot" id="dot-2"></div>
                <div class="progress-line" id="line-2"></div>
                <div class="progress-dot" id="dot-3"></div>
                <div class="progress-line" id="line-3"></div>
                <div class="progress-dot" id="dot-4"></div>
            </div>
            
            <div class="crm-wizard">
                <div class="setup-step" id="step-1">
                    <div class="d-flex align-items-center mb-3">
                        <span class="step-number" id="step-num-1">1</span>
                        <div>
                            <div class="step-title">Generate HighLevel API Key</div>
                            <div class="step-instructions">Navigate to Settings → Business Profile → API in your HighLevel account</div>
                        </div>
                    </div>
                    <div class="api-key-form">
                        <div class="mb-3">
                            <label class="form-label text-light">HighLevel API Key</label>
                            <input type="password" class="form-control form-control-dark" id="ghl-api-key" 
                                   placeholder="pit-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                                   value="{{ current_api_key or '' }}">
                            <small class="text-muted">This key is stored securely in Replit Secrets</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-light">Location ID</label>
                            <input type="text" class="form-control form-control-dark" id="ghl-location-id" 
                                   placeholder="Location ID from Settings → Business Profile"
                                   value="{{ current_location_id or '' }}">
                        </div>
                        <button class="btn btn-sovereign" onclick="saveApiKeys()">
                            <i class="fas fa-save me-2"></i>Save API Configuration
                        </button>
                        <div class="connection-status" id="save-status"></div>
                    </div>
                </div>
                
                <div class="setup-step" id="step-2">
                    <div class="d-flex align-items-center mb-3">
                        <span class="step-number" id="step-num-2">2</span>
                        <div>
                            <div class="step-title">Create CRM Tags</div>
                            <div class="step-instructions">In HighLevel, navigate to Settings → Tags and create these operative tags:</div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <span class="tag-example">PP_Recruit</span>
                        <span class="tag-example">PP_Operative</span>
                        <span class="tag-example">PP_Sovereign_Elite</span>
                        <span class="tag-example">PP_Drill_Complete</span>
                        <span class="tag-example">PP_Master_Driller</span>
                        <span class="tag-example">PP_Engaged_Reader</span>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-test" onclick="markStepComplete(2)">
                            <i class="fas fa-check me-2"></i>I've Created These Tags
                        </button>
                    </div>
                </div>
                
                <div class="setup-step" id="step-3">
                    <div class="d-flex align-items-center mb-3">
                        <span class="step-number" id="step-num-3">3</span>
                        <div>
                            <div class="step-title">Configure Webhook URL</div>
                            <div class="step-instructions">Add this webhook URL to your HighLevel Workflows for callback events:</div>
                        </div>
                    </div>
                    <div class="webhook-url">
                        <span id="webhook-url">{{ request.url_root }}api/crm/callback</span>
                        <button class="copy-btn float-end" onclick="copyWebhook()">
                            <i class="fas fa-copy me-1"></i>Copy
                        </button>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">Use this in your HighLevel Workflow triggers to send events back to Protocol Pulse (e.g., when a user books a Sovereign Alignment Call)</small>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-test" onclick="markStepComplete(3)">
                            <i class="fas fa-check me-2"></i>Webhook Configured
                        </button>
                    </div>
                </div>
                
                <div class="setup-step" id="step-4">
                    <div class="d-flex align-items-center mb-3">
                        <span class="step-number" id="step-num-4">4</span>
                        <div>
                            <div class="step-title">Test Connection</div>
                            <div class="step-instructions">Verify the bridge between Protocol Pulse and HighLevel is active</div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-sovereign" onclick="testConnection()">
                            <i class="fas fa-satellite me-2"></i>Test CRM Connection
                        </button>
                        <button class="btn btn-test ms-2" onclick="sendTestPayload()">
                            <i class="fas fa-paper-plane me-2"></i>Send Test Payload
                        </button>
                    </div>
                    <div class="connection-status" id="test-status"></div>
                </div>
            </div>
            
            <div class="diagnostic-panel">
                <h5 class="mb-3" style="color: #f5f5f5;">
                    <i class="fas fa-stethoscope me-2" style="color: #8a2be2;"></i>
                    Connection Diagnostics
                </h5>
                <div class="diagnostic-item">
                    <div class="diagnostic-icon pending" id="diag-api-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <span id="diag-api-text">API Key: Not tested</span>
                </div>
                <div class="diagnostic-item">
                    <div class="diagnostic-icon pending" id="diag-location-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <span id="diag-location-text">Location ID: Not tested</span>
                </div>
                <div class="diagnostic-item">
                    <div class="diagnostic-icon pending" id="diag-webhook-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <span id="diag-webhook-text">Webhook: Awaiting inbound request</span>
                </div>
                <div class="diagnostic-item">
                    <div class="diagnostic-icon pending" id="diag-sync-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <span id="diag-sync-text">Last Sync: Never</span>
                </div>
            </div>
            
            <div class="sarah-guidance mt-4">
                <span class="sarah-avatar">S</span>
                <strong>SARAH:</strong> "Once the HighPoint link is established, all rank progressions will automatically sync. Sovereign Elite operatives will receive their intelligence briefings through the network. The system is now primed for the 2026 economic landscape."
            </div>
        </div>
    </div>
</div>

<script>
let completedSteps = new Set();

function updateProgress() {
    for (let i = 1; i <= 4; i++) {
        const dot = document.getElementById(`dot-${i}`);
        const stepNum = document.getElementById(`step-num-${i}`);
        const step = document.getElementById(`step-${i}`);
        
        if (completedSteps.has(i)) {
            dot.classList.add('completed');
            dot.classList.remove('active');
            stepNum.classList.add('completed');
            step.classList.add('completed');
            step.classList.remove('active');
            if (i < 4) {
                document.getElementById(`line-${i}`).classList.add('completed');
            }
        }
    }
    
    const nextStep = Math.min(...[1,2,3,4].filter(s => !completedSteps.has(s)));
    if (nextStep <= 4) {
        document.getElementById(`dot-${nextStep}`).classList.add('active');
        document.getElementById(`step-${nextStep}`).classList.add('active');
    }
}

function markStepComplete(step) {
    completedSteps.add(step);
    updateProgress();
}

function saveApiKeys() {
    const apiKey = document.getElementById('ghl-api-key').value;
    const locationId = document.getElementById('ghl-location-id').value;
    const statusDiv = document.getElementById('save-status');
    
    if (!apiKey || !locationId) {
        statusDiv.className = 'connection-status error';
        statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Both API Key and Location ID are required';
        return;
    }
    
    fetch('/admin/api/crm-setup/save-keys', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({api_key: apiKey, location_id: locationId})
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            statusDiv.className = 'connection-status success';
            statusDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>API configuration saved securely to Replit Secrets';
            markStepComplete(1);
            updateDiagnostic('api', 'success', 'API Key: Configured');
            updateDiagnostic('location', 'success', 'Location ID: Configured');
        } else {
            statusDiv.className = 'connection-status error';
            statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + (data.error || 'Failed to save configuration');
        }
    })
    .catch(err => {
        statusDiv.className = 'connection-status error';
        statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Network error: ' + err.message;
    });
}

function testConnection() {
    const statusDiv = document.getElementById('test-status');
    statusDiv.className = 'connection-status';
    statusDiv.style.display = 'block';
    statusDiv.style.background = 'rgba(138, 43, 226, 0.2)';
    statusDiv.style.border = '1px solid #8a2be2';
    statusDiv.style.color = '#c9a0ff';
    statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing connection to HighLevel...';
    
    fetch('/admin/api/crm-setup/test')
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            statusDiv.className = 'connection-status success';
            statusDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>Connection successful! HighLevel API is responding.';
            markStepComplete(4);
            updateDiagnostic('sync', 'success', 'Last Sync: ' + new Date().toLocaleTimeString());
        } else {
            statusDiv.className = 'connection-status error';
            statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + (data.error || 'Connection failed');
            updateDiagnostic('api', 'error', 'API Key: ' + (data.error || 'Invalid'));
        }
    })
    .catch(err => {
        statusDiv.className = 'connection-status error';
        statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Network error: ' + err.message;
    });
}

function sendTestPayload() {
    const statusDiv = document.getElementById('test-status');
    statusDiv.className = 'connection-status';
    statusDiv.style.display = 'block';
    statusDiv.style.background = 'rgba(138, 43, 226, 0.2)';
    statusDiv.style.border = '1px solid #8a2be2';
    statusDiv.style.color = '#c9a0ff';
    statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending test "Recruit" payload to HighLevel...';
    
    fetch('/admin/api/crm-setup/send-test-payload', {method: 'POST'})
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            statusDiv.className = 'connection-status success';
            statusDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>Test payload sent successfully! Check HighLevel for the test contact.';
        } else {
            statusDiv.className = 'connection-status error';
            statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + (data.error || 'Failed to send payload');
        }
    })
    .catch(err => {
        statusDiv.className = 'connection-status error';
        statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Network error: ' + err.message;
    });
}

function copyWebhook() {
    const url = document.getElementById('webhook-url').textContent;
    navigator.clipboard.writeText(url).then(() => {
        const btn = event.target.closest('.copy-btn');
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-copy me-1"></i>Copy';
        }, 2000);
    });
}

function updateDiagnostic(type, status, text) {
    const icon = document.getElementById(`diag-${type}-icon`);
    const textEl = document.getElementById(`diag-${type}-text`);
    
    icon.className = `diagnostic-icon ${status}`;
    if (status === 'success') {
        icon.innerHTML = '<i class="fas fa-check"></i>';
    } else if (status === 'error') {
        icon.innerHTML = '<i class="fas fa-times"></i>';
    }
    textEl.textContent = text;
}

updateProgress();
</script>
{% endblock %}
