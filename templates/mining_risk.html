{% extends "base.html" %}
{% block title %}Mining Intel | Protocol Pulse{% endblock %}
{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
body { background: var(--pp-bg-primary) !important; }
.mining-risk-page {
    min-height: 100vh;
    background: var(--pp-bg-primary);
    padding: 100px 24px 60px;
    font-family: 'DM Sans', sans-serif;
}
.mining-risk-page.pp-page { color: var(--pp-text-primary); }
.mr-container { max-width: 1100px; margin: 0 auto; }
.mr-hero {
    text-align: center;
    margin-bottom: 2.5rem;
}
.mr-hero-badge {
    display: inline-block;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--pp-bitcoin);
    letter-spacing: 0.12em;
    text-transform: uppercase;
    margin-bottom: 0.75rem;
}
.mr-hero h1 {
    font-family: 'Outfit', sans-serif;
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 700;
    color: var(--pp-text-primary);
    margin-bottom: 0.5rem;
}
.mr-hero p {
    font-size: 1rem;
    color: var(--pp-text-muted);
    max-width: 560px;
    margin: 0 auto;
    line-height: 1.6;
}
.mr-live-strip {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    align-items: center;
    justify-content: center;
    padding: 1.25rem 1.5rem;
    background: var(--pp-bg-card);
    border: 1px solid var(--pp-border-subtle);
    border-radius: var(--pp-radius-lg);
    margin-bottom: 2rem;
}
.mr-live-dot {
    width: 8px;
    height: 8px;
    background: var(--pp-success);
    border-radius: 50%;
    animation: mr-pulse 2s ease-in-out infinite;
}
@keyframes mr-pulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
    50% { opacity: 0.9; }
    70% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
}
.mr-metric {
    text-align: center;
}
.mr-metric-label {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--pp-text-muted);
    margin-bottom: 0.25rem;
}
.mr-metric-value {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--pp-text-primary);
}
.mr-metric-value.orange { color: var(--pp-bitcoin); }
.mr-metric-value.blue { color: #3b82f6; }
.mr-metric-value.purple { color: var(--pp-nostr); }
.mr-metric-updated {
    font-size: 0.7rem;
    color: var(--pp-text-muted);
    margin-top: 0.5rem;
}
.mr-section-title {
    font-family: 'Outfit', sans-serif;
    font-size: 1.15rem;
    font-weight: 700;
    color: var(--pp-text-primary);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.mr-section-title::before {
    content: '';
    width: 4px;
    height: 22px;
    background: var(--pp-bitcoin);
    border-radius: 2px;
}
.mr-chart-wrap {
    background: var(--pp-bg-card);
    border: 1px solid var(--pp-border-subtle);
    border-radius: var(--pp-radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
    min-height: 380px;
}
.mr-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
    font-size: 0.75rem;
    color: var(--pp-text-muted);
}
.mr-legend span { display: flex; align-items: center; gap: 0.4rem; }
.mr-legend i { width: 12px; height: 4px; border-radius: 2px; display: inline-block; }
.mr-table-wrap {
    overflow-x: auto;
    background: var(--pp-bg-card);
    border: 1px solid var(--pp-border-subtle);
    border-radius: var(--pp-radius-lg);
}
.mr-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}
.mr-table th {
    text-align: left;
    padding: 12px 16px;
    font-family: 'Outfit', sans-serif;
    font-weight: 600;
    color: var(--pp-text-muted);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    border-bottom: 1px solid var(--pp-border-subtle);
}
.mr-table td {
    padding: 14px 16px;
    border-bottom: 1px solid var(--pp-border-subtle);
    color: var(--pp-text-secondary);
}
.mr-table tr:last-child td { border-bottom: none; }
.mr-table tr:hover td { background: var(--pp-bg-elevated); }
.mr-table .name { font-weight: 600; color: var(--pp-text-primary); }
.mr-table .code { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: var(--pp-text-muted); }
.mr-table .num { font-family: 'JetBrains Mono', monospace; text-align: right; }
.mr-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: var(--pp-radius-full);
    font-size: 0.7rem;
    font-weight: 600;
}
.mr-badge.vhigh { background: rgba(239,68,68,0.2); color: #f87171; }
.mr-badge.high { background: rgba(249,115,22,0.2); color: #fb923c; }
.mr-badge.med { background: rgba(234,179,8,0.2); color: #facc15; }
.mr-badge.low { background: rgba(34,197,94,0.2); color: #4ade80; }
.mr-badge.vlow { background: rgba(34,197,94,0.15); color: #86efac; }
.mr-note { font-size: 0.8rem; color: var(--pp-text-muted); max-width: 280px; line-height: 1.4; }
.mr-footer {
    margin-top: 2.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--pp-border-subtle);
    font-size: 0.8rem;
    color: var(--pp-text-muted);
    text-align: center;
}
</style>
{% endblock %}

{% block content %}
<div class="mining-risk-page pp-page">
    <div class="mr-container">
        <header class="mr-hero">
            <span class="mr-hero-badge"><i class="fas fa-microchip"></i> Mining Intel</span>
            <h1>Mining Intel</h1>
            <p>Live hashrate and difficulty plus risk by geography for deploying Bitcoin mining. Composite risk scores (regulatory, energy cost, stability) to compare jurisdictions.</p>
        </header>

        <div class="mr-live-strip" id="mrLiveStrip">
            <div class="mr-metric">
                <span class="mr-live-dot"></span>
                <span style="font-size: 0.7rem; color: var(--pp-text-muted); margin-left: 6px;">LIVE</span>
            </div>
            <div class="mr-metric">
                <div class="mr-metric-label">Hashrate</div>
                <div class="mr-metric-value orange" id="mrHashrate">— EH/s</div>
            </div>
            <div class="mr-metric">
                <div class="mr-metric-label">Difficulty</div>
                <div class="mr-metric-value blue" id="mrDifficulty">— T</div>
            </div>
            <div class="mr-metric">
                <div class="mr-metric-label">Retarget progress</div>
                <div class="mr-metric-value purple" id="mrProgress">—%</div>
            </div>
            <div class="mr-metric-updated" id="mrUpdated">Updating…</div>
        </div>

        <h2 class="mr-section-title">Composite risk by jurisdiction</h2>
        <div class="mr-legend">
            <span><i style="background: #22c55e;"></i> Very low</span>
            <span><i style="background: #4ade80;"></i> Low</span>
            <span><i style="background: #eab308;"></i> Medium</span>
            <span><i style="background: #f97316;"></i> High</span>
            <span><i style="background: #ef4444;"></i> Very high</span>
        </div>
        <div class="mr-chart-wrap">
            <canvas id="mrChart" width="800" height="340"></canvas>
        </div>

        <h2 class="mr-section-title">Risk breakdown by region</h2>
        <div class="mr-table-wrap">
            <table class="mr-table" id="mrTable">
                <thead>
                    <tr>
                        <th>Location</th>
                        <th class="num">Regulatory</th>
                        <th class="num">Energy cost</th>
                        <th class="num">Stability</th>
                        <th class="num">Composite</th>
                        <th>Label</th>
                        <th>Note</th>
                    </tr>
                </thead>
                <tbody id="mrTableBody">
                    <tr><td colspan="7" style="text-align: center; color: var(--pp-text-muted);">Loading…</td></tr>
                </tbody>
            </table>
        </div>

        <p class="mr-footer">
            Risk scores are indicative (0–100). Composite = 40% regulatory + 30% energy cost + 30% stability. Network metrics from mempool.space. Not financial or legal advice.
        </p>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function() {
    let mrChart = null;
    function riskColor(score) {
        if (score >= 70) return '#ef4444';
        if (score >= 55) return '#f97316';
        if (score >= 40) return '#eab308';
        if (score >= 25) return '#4ade80';
        return '#22c55e';
    }
    function badgeClass(score) {
        if (score >= 70) return 'vhigh';
        if (score >= 55) return 'high';
        if (score >= 40) return 'med';
        if (score >= 25) return 'low';
        return 'vlow';
    }
    function updateMetrics(network) {
        if (!network) return;
        var el = document.getElementById('mrHashrate');
        if (el) el.textContent = (network.hashrate_eh || 0) + ' EH/s';
        el = document.getElementById('mrDifficulty');
        if (el) el.textContent = (network.difficulty ? (network.difficulty / 1e12).toFixed(2) : '—') + ' T';
        el = document.getElementById('mrProgress');
        if (el) el.textContent = (network.difficulty_progress_percent != null ? network.difficulty_progress_percent : '—') + '%';
        el = document.getElementById('mrUpdated');
        if (el && network.updated_at) {
            var d = new Date(network.updated_at);
            el.textContent = 'Updated ' + d.toLocaleTimeString();
        }
    }
    function drawChart(regions) {
        var ctx = document.getElementById('mrChart');
        if (!ctx || !regions || regions.length === 0) return;
        var labels = regions.map(function(r) { return r.name; });
        var data = regions.map(function(r) { return r.composite_risk; });
        var colors = data.map(riskColor);
        if (mrChart) mrChart.destroy();
        mrChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Composite risk (0–100)',
                    data: data,
                    backgroundColor: colors,
                    borderColor: colors.map(function(c) { return c; }),
                    borderWidth: 1,
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) { return 'Risk: ' + ctx.raw + ' (higher = riskier)'; }
                        }
                    }
                },
                scales: {
                    x: {
                        min: 0,
                        max: 100,
                        grid: { color: 'rgba(255,255,255,0.06)' },
                        ticks: { color: 'rgba(255,255,255,0.5)', font: { size: 11 } }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { color: 'rgba(255,255,255,0.78)', font: { size: 11 } }
                    }
                }
            }
        });
    }
    function fillTable(regions) {
        var tbody = document.getElementById('mrTableBody');
        if (!tbody) return;
        if (!regions || regions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--pp-text-muted);">No data</td></tr>';
            return;
        }
        tbody.innerHTML = regions.map(function(r) {
            return '<tr>' +
                '<td><span class="name">' + (r.name || '').replace(/</g,'&lt;') + '</span><br><span class="code">' + (r.code || '') + '</span></td>' +
                '<td class="num">' + (r.regulatory_risk != null ? r.regulatory_risk : '—') + '</td>' +
                '<td class="num">' + (r.energy_cost_risk != null ? r.energy_cost_risk : '—') + '</td>' +
                '<td class="num">' + (r.stability_risk != null ? r.stability_risk : '—') + '</td>' +
                '<td class="num"><strong>' + (r.composite_risk != null ? r.composite_risk : '—') + '</strong></td>' +
                '<td><span class="mr-badge ' + badgeClass(r.composite_risk || 0) + '">' + (r.risk_label || '—') + '</span></td>' +
                '<td><span class="mr-note">' + (r.note || '—').replace(/</g,'&lt;') + '</span></td>' +
                '</tr>';
        }).join('');
    }
    function fetchData() {
        fetch('/api/mining-risk')
            .then(function(r) { return r.json(); })
            .then(function(res) {
                var regions = res.regions || [];
                var network = res.network || {};
                updateMetrics(network);
                drawChart(regions);
                fillTable(regions);
            })
            .catch(function() {
                document.getElementById('mrTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--pp-accent);">Failed to load. Retry in a moment.</td></tr>';
            });
    }
    fetchData();
    setInterval(fetchData, 30000);
})();
</script>
{% endblock %}
