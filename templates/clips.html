{% extends "base.html" %}

{% block title %}Signal Clips | Protocol Pulse{% endblock %}

{% block content %}
<section class="container py-4 py-md-5">
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
    <div>
      <h1 class="text-white mb-1">Signal Clips</h1>
      <p class="text-muted small mb-0">High-signal moments extracted from the noise</p>
    </div>
    <a class="btn btn-outline-light btn-sm" href="/hub">Back to Hub</a>
  </div>

  {% if status %}
  <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
    <span class="badge {{ 'bg-success' if status.get('ffmpeg_available') else 'bg-secondary' }}">FFmpeg</span>
    <span class="badge {{ 'bg-success' if status.get('ytdlp_available') else 'bg-secondary' }}">yt-dlp</span>
    <span class="badge {{ 'bg-success' if status.get('openai_configured') else 'bg-secondary' }}">AI</span>
    <span class="badge bg-dark border border-secondary">{{ status.get('clips_count', 0) }} clips</span>
  </div>
  {% endif %}

  {% if current_user.is_authenticated and current_user.is_admin %}
  <div class="mb-4">
    <button type="button" class="btn btn-danger" id="generate-clips-btn" onclick="generateClips()">
      <i class="fas fa-magic"></i> Generate Daily Clips
    </button>
    <span class="text-muted small ms-2">Pulls from Protocol Pulse + partner channels</span>
  </div>
  {% endif %}

  <h2 class="h5 text-white mb-3">Reel feed</h2>

  {% if (clip_jobs or [])|length == 0 %}
    <div class="alert alert-secondary">No reels yet. Auto-job runs every 30m (monitor → clip → narration).</div>
  {% else %}
    <div class="row g-4">
      {% for j in (clip_jobs or []) %}
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card bg-dark border-secondary h-100">
          <div class="card-body p-0 d-flex flex-column">
            {% if j.output_path %}
            <div class="position-relative bg-black rounded-top overflow-hidden" style="aspect-ratio: 9/16; max-height: 360px;">
              <video
                class="w-100 h-100"
                style="object-fit: contain;"
                controls
                preload="metadata"
                playsinline
                poster=""
              >
                <source src="{{ url_for('serve_clip_file', filename=j.output_path|basename) }}" type="video/mp4">
                Your browser does not support the video tag.
              </video>
              <div class="position-absolute bottom-0 start-0 end-0 p-2" style="background: linear-gradient(transparent, rgba(0,0,0,0.8));">
                <span class="badge bg-danger">Protocol Pulse</span>
              </div>
            </div>
            {% else %}
            <div class="bg-secondary bg-opacity-25 rounded-top d-flex align-items-center justify-content-center" style="aspect-ratio: 9/16; min-height: 200px;">
              <div class="text-center text-muted py-3">
                <i class="fas fa-film fa-2x mb-2"></i>
                <div class="small">No output yet</div>
                <span class="badge bg-secondary mt-1">{{ j.status or 'Planned' }}</span>
              </div>
            </div>
            {% endif %}

            <div class="card-body flex-grow-1">
              <div class="d-flex justify-content-between align-items-start gap-2">
                <span class="text-white fw-semibold small text-truncate" title="{{ j.video_id }}">{{ j.video_id }}</span>
                <span class="badge {% if j.status == 'Completed' %}bg-success{% elif j.status == 'Failed' %}bg-danger{% elif j.status == 'Processing' %}bg-info{% else %}bg-secondary{% endif %}">{{ j.status or '—' }}</span>
              </div>
              <div class="text-muted small mt-1">{{ j.channel_name or 'Partner' }}</div>
              <div class="text-muted small mt-1">{{ j.created_at.strftime('%Y-%m-%d %H:%M') if j.created_at else '—' }}</div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% endif %}

  {% if (clips or [])|length > 0 %}
  <h2 class="h5 text-white mt-5 mb-3">Legacy clips</h2>
  <div class="row g-3">
    {% for c in (clips or [])[:12] %}
    <div class="col-6 col-md-4 col-lg-3">
      <div class="card bg-dark border-secondary">
        {% if c.get('url') or c.get('src') %}
        <video class="card-img-top" controls preload="metadata" style="max-height: 200px;">
          <source src="{{ c.url or c.src }}" type="video/mp4">
        </video>
        {% endif %}
        <div class="card-body py-2">
          <div class="text-white small text-truncate">{{ c.get('title') or c.get('id') or 'Clip' }}</div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% endif %}
</section>
{% endblock %}

{% block scripts %}
<script>
async function generateClips() {
  var btn = document.getElementById('generate-clips-btn');
  if (!btn) return;
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
  try {
    var r = await fetch('/admin/api/clips/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
    var data = await r.json();
    if (data.clips_created > 0) {
      alert('Generated ' + data.clips_created + ' new clip(s). Refreshing...');
      window.location.reload();
    } else if (data.errors && data.errors.length) {
      alert('Issues: ' + (data.message || data.errors.join('; ')));
    } else {
      alert(data.message || 'No new clips. No new videos available or daily limits reached.');
    }
  } catch (e) {
    console.error(e);
    alert('Request failed. Check console.');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-magic"></i> Generate Daily Clips';
  }
}
</script>
{% endblock %}
