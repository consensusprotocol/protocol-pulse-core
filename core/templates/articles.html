{% extends "base.html" %}
{% block title %}Intelligence Terminal — Protocol Pulse{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/articles-terminal.css') }}?v=terminal2">
<style>
  body { background: #0A0A0A !important; }
  .intel-category-bar { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0.75rem 1rem; border-bottom: 1px solid rgba(220,38,38,0.2); margin-bottom: 0.5rem; }
  .intel-category-pill { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.08em; color: rgba(255,255,255,0.65); text-decoration: none; padding: 0.4rem 0.85rem; border: 1px solid rgba(220,38,38,0.2); border-radius: 4px; }
  .intel-category-pill.active { background: #DC2626; border-color: #DC2626; color: #fff; }
  .intel-terminal-wrap { display: grid; grid-template-columns: 1fr 320px; gap: 1.25rem; max-width: 1400px; margin: 0 auto; padding: 1rem; }
  .intel-bento-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; }
</style>
{% endblock %}

{% block content %}
{% set articles = (today_articles or []) + (yesterday_articles or []) + (archive_articles or []) %}
{% set default_img = default_header_url or 'https://images.unsplash.com/photo-1639762681485-074b7f938ba0?w=1200' %}

<!-- Breaking News Ticker (last 5) -->
<section class="intel-ticker-wrap">
  <div class="container-fluid d-flex align-items-center">
    <span class="intel-ticker-label">Breaking Intelligence</span>
    <div class="intel-ticker">
      {% for title in (ticker_titles or []) %}
      <span>{{ title }}</span>
      {% endfor %}
      {% for title in (ticker_titles or []) %}
      <span>{{ title }}</span>
      {% endfor %}
    </div>
  </div>
</section>

<!-- Intelligence Zones (Bloomberg-style tabs) -->
<nav class="intel-category-bar intel-zones" role="tablist" aria-label="Intelligence Zones">
  <button type="button" class="intel-category-pill intel-zone-tab active" data-zone="all" aria-selected="true">All</button>
  <button type="button" class="intel-category-pill intel-zone-tab" data-zone="bitcoin">Bitcoin</button>
  <button type="button" class="intel-category-pill intel-zone-tab" data-zone="macro">Macro</button>
  <button type="button" class="intel-category-pill intel-zone-tab" data-zone="privacy">Privacy</button>
  <button type="button" class="intel-category-pill intel-zone-tab" data-zone="mining">Mining</button>
  {% for cat in (categories or []) %}
  {% if cat not in ['Bitcoin', 'Macro', 'Privacy', 'Mining'] %}
  <a href="{{ url_for('category_articles', category=cat) }}" class="intel-category-pill">{{ cat }}</a>
  {% endif %}
  {% endfor %}
</nav>

<div class="intel-terminal-wrap">
  <div class="intel-bento-main">
    {% if latest_article %}
    <section class="intel-hero-zone" data-intel-zone="{{ ((latest_article.category or '')|lower|replace(' ', '-')) or 'all' }}">
      <div class="intel-hero-card">
        <div class="intel-hero-bg intel-image-overlay" style="background-image: url({{ latest_article.header_image_url or default_img }});"></div>
        <div class="intel-hero-content">
          <span class="intel-hero-tag intel-hero-tag-breaking">BREAKING SIGNAL</span>
          <a href="{{ url_for('article_detail', article_id=latest_article.id) }}" class="intel-hero-link">
            <h2 class="intel-hero-title">{{ latest_article.title }}</h2>
          </a>
          <div class="intel-hero-meta">
            <span class="intel-hero-cat">{{ latest_article.category or 'Intel' }}</span>
            <span>{{ (((latest_article.content or '')|striptags).split()|length / 200)|int or 1 }} min read</span>
            {% if latest_article.created_at %}<span>{{ latest_article.created_at.strftime('%b %d, %Y') }}</span>{% endif %}
          </div>
        </div>
      </div>
    </section>
    {% endif %}

    <h2 class="intel-grid-section-title">Intelligence Feed</h2>
    <div class="intel-bento-grid">
      {% for article in (grid_articles or []) %}
      {% set word_count = ((article.content or '')|striptags).split()|length %}
      {% set read_mins = ((word_count / 200)|int) if (word_count / 200)|int >= 1 else 1 %}
      {% set signal_pct = (100 - loop.index0 * 2) if (100 - loop.index0 * 2) >= 40 else 40 %}
      <article class="intel-card" data-intel-zone="{{ ((article.category or '')|lower|replace(' ', '-')) or 'all' }}">
        <div class="intel-card-signal">
          <div class="intel-card-signal-bar" style="--signal-pct: {{ signal_pct }}%;"></div>
        </div>
        <span class="intel-card-time">{{ read_mins }} min read</span>
        <h3 class="intel-card-title">
          <a href="{{ url_for('article_detail', article_id=article.id) }}">{{ article.title }}</a>
        </h3>
        <p class="intel-card-preview">{{ article.content|striptags|truncate(120) }}</p>
        <a href="{{ url_for('article_detail', article_id=article.id) }}" class="intel-card-link">Read intel →</a>
      </article>
      {% endfor %}
    </div>
    {% if not (grid_articles or []) and (total_count or 0) == 0 %}
    <p class="text-muted">No articles yet.</p>
    {% endif %}

    <!-- Pagination: all articles accessible (1,370+ supported) -->
    {% if (total_pages or 1) > 1 %}
    <nav class="intel-pagination" aria-label="Articles pages">
      <div class="intel-pagination-inner">
        {% if page and page > 1 %}
        <a href="{{ url_for('articles', page=page - 1) }}" class="intel-pagination-btn">← Prev</a>
        {% endif %}
        <span class="intel-pagination-info">Page {{ page or 1 }} of {{ total_pages or 1 }} ({{ total_count or 0 }} intel)</span>
        {% if page and total_pages and page < total_pages %}
        <a href="{{ url_for('articles', page=page + 1) }}" class="intel-pagination-btn">Next →</a>
        {% endif %}
      </div>
      <div class="intel-pagination-jump">
        <a href="{{ url_for('articles', page=1) }}" class="intel-pagination-num {% if (page or 1) == 1 %}active{% endif %}">1</a>
        {% if (page or 1) > 3 %}<span class="intel-pagination-ellipsis">…</span>{% endif %}
        {% for p in range([2, (page or 1) - 2]|max, [(total_pages or 1) - 1, (page or 1) + 2]|min + 1) %}
        <a href="{{ url_for('articles', page=p) }}" class="intel-pagination-num {% if p == (page or 1) %}active{% endif %}">{{ p }}</a>
        {% endfor %}
        {% if total_pages and (page or 1) < (total_pages or 1) - 2 %}<span class="intel-pagination-ellipsis">…</span>{% endif %}
        {% if (total_pages or 1) > 1 %}
        <a href="{{ url_for('articles', page=total_pages or 1) }}" class="intel-pagination-num {% if (page or 1) == (total_pages or 1) %}active{% endif %}">{{ total_pages or 1 }}</a>
        {% endif %}
      </div>
    </nav>
    {% endif %}
  </div>

  <!-- Sidebar HUD: live financial stats (sticky) -->
  <aside class="intel-sidebar">
    <h2 class="intel-sidebar-title">Live HUD</h2>
    <div class="intel-sidebar-row">
      <span class="intel-sidebar-label">BTC</span>
      <span class="intel-sidebar-value">
        {% if prices and (prices.get('bitcoin') or {}).get('price') %}
        ${{ "{:,.0f}".format((prices.get('bitcoin') or {}).get('price', 0)) }}
        {% else %}
        —
        {% endif %}
      </span>
    </div>
    <div class="intel-sidebar-row">
      <span class="intel-sidebar-label">Hashrate</span>
      <span class="intel-sidebar-value">{{ (network_stats or {}).get('hashrate', (mempool_data or {}).get('current_hashrate')) or '—' }}</span>
    </div>
    <div class="intel-sidebar-row">
      <span class="intel-sidebar-label">Mempool</span>
      <span class="intel-sidebar-value">{{ (mempool_data or {}).get('count', '—') }} tx</span>
    </div>
    {% if mempool_data and mempool_data.get('fees') %}
    <div class="intel-sidebar-row">
      <span class="intel-sidebar-label">Fee (fast)</span>
      <span class="intel-sidebar-value">{{ mempool_data.fees.get('fastest', mempool_data.fees.get('fastestFee', '—')) }} sat/vB</span>
    </div>
    {% endif %}
    {% if network_stats and network_stats.get('difficulty') %}
    <div class="intel-sidebar-row">
      <span class="intel-sidebar-label">Difficulty</span>
      <span class="intel-sidebar-value">{{ network_stats.difficulty }}</span>
    </div>
    {% endif %}
  </aside>
</div>
<script>
(function() {
  var zoneMap = { bitcoin: ['bitcoin'], macro: ['macro', 'regulation', 'economy', 'defi'], privacy: ['privacy', 'cypherpunk'], mining: ['mining'] };
  var tabs = document.querySelectorAll('.intel-zone-tab');
  var cards = document.querySelectorAll('.intel-card, .intel-hero-zone');
  function filterZone(zone) {
    var match = zone === 'all';
    var keys = match ? [] : (zoneMap[zone] || [zone]);
    cards.forEach(function(el) {
      var z = (el.getAttribute('data-intel-zone') || '').toLowerCase().replace(/\s+/g, '-');
      var show = match || keys.some(function(k) { return z.indexOf(k) !== -1; });
      el.style.display = show ? '' : 'none';
    });
    tabs.forEach(function(t) {
      t.classList.toggle('active', t.getAttribute('data-zone') === zone);
      t.setAttribute('aria-selected', t.getAttribute('data-zone') === zone ? 'true' : 'false');
    });
  }
  tabs.forEach(function(t) {
    t.addEventListener('click', function() { filterZone(t.getAttribute('data-zone')); });
  });
})();
</script>
{% endblock %}
