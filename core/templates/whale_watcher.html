{% extends "base.html" %}

{% block title %}Whale Watcher | Protocol Pulse{% endblock %}

{% block head %}
<style>
:root {
    --pp-red: #dc2626;
    --pp-dark: #0a0a0a;
    --pp-glass: rgba(10, 10, 10, 0.95);
}

.whale-page {
    min-height: 100vh;
    background: linear-gradient(135deg, #0a0a0a 0%, #1a0505 100%);
    padding: 100px 20px 40px;
}

.whale-header {
    text-align: center;
    margin-bottom: 40px;
}

.back-nav {
    position: fixed;
    top: 80px;
    left: 20px;
    z-index: 1000;
}

.back-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: var(--pp-glass);
    border: 1px solid rgba(220, 38, 38, 0.3);
    border-radius: 12px;
    padding: 12px 20px;
    color: #fff;
    text-decoration: none;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    backdrop-filter: blur(20px);
    transition: all 0.3s ease;
}

.back-btn:hover {
    background: rgba(220, 38, 38, 0.2);
    border-color: var(--pp-red);
    color: #fff;
    transform: translateX(-3px);
}

.back-btn i {
    color: var(--pp-red);
}

.whale-title {
    font-family: 'JetBrains Mono', monospace;
    font-size: 2.5rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 10px;
}

.whale-title i {
    color: var(--pp-red);
    margin-right: 15px;
}

.whale-subtitle {
    color: rgba(255, 255, 255, 0.5);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    letter-spacing: 2px;
    text-transform: uppercase;
}

.whale-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    max-width: 1000px;
    margin: 0 auto 40px;
}

.whale-stat {
    background: var(--pp-glass);
    border: 1px solid rgba(220, 38, 38, 0.2);
    border-radius: 12px;
    padding: 25px;
    text-align: center;
    backdrop-filter: blur(20px);
}

.stat-label {
    font-family: 'JetBrains Mono', monospace;
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
}

.stat-value {
    font-family: 'JetBrains Mono', monospace;
    color: #fff;
    font-size: 1.8rem;
    font-weight: 700;
}

.stat-value.red { color: var(--pp-red); }
.stat-value.green { color: #22c55e; }

.whale-feed {
    max-width: 1200px;
    margin: 0 auto;
}

.feed-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 0 10px;
}

.feed-title {
    font-family: 'JetBrains Mono', monospace;
    color: var(--pp-red);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 2px;
}

.feed-status {
    display: flex;
    align-items: center;
    gap: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: #22c55e;
}

.status-dot {
    width: 8px;
    height: 8px;
    background: #22c55e;
    border-radius: 50%;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.whale-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.whale-tx {
    background: var(--pp-glass);
    border: 1px solid rgba(220, 38, 38, 0.2);
    border-radius: 12px;
    padding: 20px 25px;
    display: grid;
    grid-template-columns: auto 1fr auto auto;
    gap: 20px;
    align-items: center;
    backdrop-filter: blur(20px);
    transition: all 0.3s ease;
    animation: slideIn 0.5s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.whale-tx:hover {
    border-color: var(--pp-red);
    transform: translateX(5px);
}

.whale-tx.mega {
    border-color: #eab308;
    background: rgba(234, 179, 8, 0.1);
}

.tx-icon {
    width: 50px;
    height: 50px;
    background: rgba(220, 38, 38, 0.2);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.tx-icon.mega {
    background: rgba(234, 179, 8, 0.2);
}

.tx-icon i {
    color: var(--pp-red);
}

.tx-icon.mega i {
    color: #eab308;
}

.tx-info {
    overflow: hidden;
}

.tx-amount {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.3rem;
    font-weight: 700;
    color: #fff;
    margin-bottom: 5px;
}

.tx-hash {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.4);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.tx-hash a {
    color: rgba(255, 255, 255, 0.4);
    text-decoration: none;
}

.tx-hash a:hover {
    color: var(--pp-red);
}

.tx-usd {
    font-family: 'JetBrains Mono', monospace;
    font-size: 1.1rem;
    color: #22c55e;
    text-align: right;
}

.tx-time {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.4);
    text-align: right;
    min-width: 80px;
}

.loading-indicator {
    text-align: center;
    padding: 60px;
    color: rgba(255, 255, 255, 0.5);
    font-family: 'JetBrains Mono', monospace;
}

.empty-state {
    text-align: center;
    padding: 80px 20px;
    color: rgba(255, 255, 255, 0.4);
    font-family: 'JetBrains Mono', monospace;
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 20px;
    opacity: 0.3;
}

@media (max-width: 768px) {
    .whale-tx {
        grid-template-columns: auto 1fr;
        gap: 15px;
    }
    .tx-usd, .tx-time {
        display: none;
    }
    .whale-title {
        font-size: 1.8rem;
    }
}
</style>
{% endblock %}

{% block content %}
<nav class="back-nav">
    <a href="/" class="back-btn">
        <i class="fas fa-arrow-left"></i>
        <span>Back to Home</span>
    </a>
</nav>

<div class="whale-page">
    <div class="whale-header">
        <h1 class="whale-title"><i class="fas fa-water"></i>Whale Watcher</h1>
        <p class="whale-subtitle">Real-time large transaction surveillance</p>
    </div>
    
    <div class="whale-stats">
        <div class="whale-stat">
            <div class="stat-label">24h Whale Volume</div>
            <div class="stat-value" id="total-volume">--</div>
        </div>
        <div class="whale-stat">
            <div class="stat-label">Solo Slayers</div>
            <div class="stat-value" id="solo-count" style="color: #22c55e;">--</div>
        </div>
        <div class="whale-stat">
            <div class="stat-label">Pool Payouts</div>
            <div class="stat-value" id="pool-count" style="color: #3b82f6;">--</div>
        </div>
        <div class="whale-stat">
            <div class="stat-label">BTC Price</div>
            <div class="stat-value" id="btc-price">--</div>
        </div>
    </div>
    
    <!-- Solo Slayer Legend -->
    <div style="max-width: 1000px; margin: 0 auto 30px; display: flex; justify-content: center; gap: 40px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem;">
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="width: 12px; height: 12px; background: #22c55e; border-radius: 50%; box-shadow: 0 0 10px #22c55e;"></span>
            <span style="color: #22c55e;">SOLO SLAYER</span>
            <span style="color: #666;">(Bitaxe/CKPool)</span>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="width: 12px; height: 12px; background: #3b82f6; border-radius: 50%; box-shadow: 0 0 10px #3b82f6;"></span>
            <span style="color: #3b82f6;">POOL PAYOUT</span>
            <span style="color: #666;">(AntPool/F2Pool)</span>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="width: 12px; height: 12px; background: #eab308; border-radius: 50%; box-shadow: 0 0 10px #eab308;"></span>
            <span style="color: #eab308;">MEGA WHALE</span>
            <span style="color: #666;">(500+ BTC)</span>
        </div>
    </div>
    
    <div class="whale-feed">
        <div class="feed-header">
            <div class="feed-title"><i class="fas fa-rss me-2"></i>Live Feed (10+ BTC)</div>
            <div class="feed-status">
                <span class="status-dot"></span>
                <span>Monitoring Mempool</span>
            </div>
        </div>
        
        <div class="whale-list" id="whale-list">
            {% if initial_whales %}
            {% for whale in initial_whales %}
            <div class="whale-tx {{ 'mega' if whale.is_mega else '' }}" data-txid="{{ whale.txid }}">
                <div class="tx-icon {{ 'mega' if whale.is_mega else '' }}">
                    <i class="fas fa-water"></i>
                </div>
                <div class="tx-info">
                    <div class="tx-amount">{{ "%.4f"|format(whale.btc_amount) }} BTC</div>
                    <div class="tx-hash"><a href="https://mempool.space/tx/{{ whale.txid }}" target="_blank">{{ whale.txid[:16] }}...</a></div>
                </div>
                <div class="tx-usd">${{ "{:,.0f}".format(whale.usd_value or whale.btc_amount * 100000) }}</div>
                <div class="tx-time">{{ whale.detected_at[:10] if whale.detected_at else 'Recent' }}</div>
            </div>
            {% endfor %}
            {% else %}
            <div class="loading-indicator">
                <i class="fas fa-circle-notch fa-spin me-2"></i>
                Scanning for whale activity...
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let btcPrice = 100000;
let whaleTransactions = {{ initial_whales | tojson | safe if initial_whales else '[]' }};
let totalVolume = whaleTransactions.reduce((sum, w) => sum + (w.btc_amount || 0), 0);
let largestTx = whaleTransactions.length > 0 ? Math.max(...whaleTransactions.map(w => w.btc_amount || 0)) : 0;
let soloCount = 0;
let poolCount = 0;

// COINBASE AUDITOR - Mining Pool Signature Detection
const POOL_SIGNATURES = {
    'AntPool': ['Mined by AntPool', 'antpool.com'],
    'F2Pool': ['Mined by Fish', 'f2pool', '七彩神仙鱼'],
    'Foundry': ['foundry', 'Foundry USA'],
    'Binance': ['binance', 'Binance Pool'],
    'ViaBTC': ['ViaBTC', 'viabtc.com'],
    'Poolin': ['poolin', 'Poolin.com'],
    'SlushPool': ['slush', 'braiins'],
    'BTCcom': ['btc.com', 'BTC.com'],
    'MARA': ['MARA Pool', 'Marathon'],
    'Luxor': ['Luxor']
};

const SOLO_SIGNATURES = {
    'CKPool': ['ckpool', 'solo.ckpool'],
    'Bitaxe': ['bitaxe'],
    'OCEAN': ['ocean', 'ocean.xyz'],
    'Solo Mining': ['solo', 'SOLO'],
    'Unknown Solo': []
};

function auditCoinbase(coinbaseHex, coinbaseText) {
    const text = (coinbaseText || '').toLowerCase();
    const hex = (coinbaseHex || '').toLowerCase();
    
    for (const [pool, sigs] of Object.entries(POOL_SIGNATURES)) {
        for (const sig of sigs) {
            if (text.includes(sig.toLowerCase()) || hex.includes(stringToHex(sig).toLowerCase())) {
                return { type: 'pool', name: pool, color: '#3b82f6', icon: 'fa-building' };
            }
        }
    }
    
    for (const [pool, sigs] of Object.entries(SOLO_SIGNATURES)) {
        for (const sig of sigs) {
            if (text.includes(sig.toLowerCase()) || hex.includes(stringToHex(sig).toLowerCase())) {
                return { type: 'solo', name: pool, color: '#22c55e', icon: 'fa-bolt' };
            }
        }
    }
    
    return { type: 'unknown', name: 'Unknown', color: '#888', icon: 'fa-question' };
}

function stringToHex(str) {
    return str.split('').map(c => c.charCodeAt(0).toString(16).padStart(2, '0')).join('');
}

// Normalize initial whale data from server (btc_amount -> btc)
whaleTransactions = whaleTransactions.map(w => ({
    txid: w.txid,
    btc: w.btc_amount || w.btc || 0,
    fee: w.fee || 0,
    time: w.detected_at ? new Date(w.detected_at).getTime() : Date.now(),
    minerType: w.minerType || 'unknown',
    minerName: w.minerName || 'Unknown'
}));

// Recalculate totals after normalization
totalVolume = whaleTransactions.reduce((sum, w) => sum + (w.btc || 0), 0);
largestTx = whaleTransactions.length > 0 ? Math.max(...whaleTransactions.map(w => w.btc || 0)) : 0;

// Initialize stats immediately if we have initial data
if (whaleTransactions.length > 0) {
    updateUI();
}

async function fetchBtcPrice() {
    try {
        const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
        const data = await response.json();
        btcPrice = data.bitcoin.usd;
        document.getElementById('btc-price').textContent = '$' + btcPrice.toLocaleString();
    } catch (error) {
        console.error('Price fetch error:', error);
    }
}

async function loadStoredWhales() {
    try {
        const response = await fetch('/api/whales');
        const data = await response.json();
        if (data.whales && data.whales.length > 0) {
            data.whales.forEach(w => {
                if (!whaleTransactions.find(wt => wt.txid === w.txid)) {
                    whaleTransactions.push({
                        txid: w.txid,
                        btc: w.btc,
                        fee: 0,
                        time: w.time ? new Date(w.time).getTime() : Date.now(),
                        stored: true
                    });
                    totalVolume += w.btc;
                    if (w.btc > largestTx) largestTx = w.btc;
                }
            });
            updateUI();
        }
    } catch (error) {
        console.error('Stored whales error:', error);
    }
}

async function saveWhale(whale) {
    try {
        await fetch('/api/whales/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                txid: whale.txid,
                btc: whale.btc,
                usd: whale.btc * btcPrice,
                fee: whale.fee
            })
        });
    } catch (error) {
        console.error('Save whale error:', error);
    }
}

async function fetchWhaleTransactions() {
    try {
        const response = await fetch('/api/whales/live');
        const data = await response.json();
        
        if (data.whales && data.whales.length > 0) {
            for (const whale of data.whales) {
                if (!whaleTransactions.find(w => w.txid === whale.txid)) {
                    whaleTransactions.unshift({
                        txid: whale.txid,
                        btc: whale.btc,
                        fee: whale.fee || 0,
                        time: whale.time || Date.now()
                    });
                    totalVolume += whale.btc;
                    if (whale.btc > largestTx) largestTx = whale.btc;
                    await saveWhale(whale);
                }
            }
            
            whaleTransactions = whaleTransactions.slice(0, 50);
            updateUI();
        }
        
        if (whaleTransactions.length === 0) {
            await fetchRecentBlocks();
        }
        
    } catch (error) {
        console.error('Whale fetch error:', error);
        await fetchRecentBlocks();
    }
}

async function fetchRecentBlocks() {
    try {
        const blocksResponse = await fetch('https://mempool.space/api/blocks');
        const blocks = await blocksResponse.json();
        
        for (const block of blocks.slice(0, 5)) {
            const txResponse = await fetch(`https://mempool.space/api/block/${block.id}/txs`);
            const transactions = await txResponse.json();
            
            const coinbaseTx = transactions[0];
            let minerInfo = { type: 'unknown', name: 'Unknown' };
            
            if (coinbaseTx && coinbaseTx.vin && coinbaseTx.vin[0]) {
                const coinbaseHex = coinbaseTx.vin[0].scriptsig || '';
                const coinbaseText = block.extras?.pool?.name || '';
                minerInfo = auditCoinbase(coinbaseHex, coinbaseText);
                
                if (block.extras?.pool?.name) {
                    const poolName = block.extras.pool.name.toLowerCase();
                    if (poolName.includes('ckpool') || poolName.includes('ocean') || poolName.includes('solo')) {
                        minerInfo = { type: 'solo', name: block.extras.pool.name, color: '#22c55e', icon: 'fa-bolt' };
                    } else {
                        minerInfo = { type: 'pool', name: block.extras.pool.name, color: '#3b82f6', icon: 'fa-building' };
                    }
                }
            }
            
            transactions.forEach(tx => {
                const outputs = tx.vout || [];
                const totalOut = outputs.reduce((sum, out) => sum + (out.value || 0), 0);
                const btcValue = totalOut / 100000000;
                
                if (btcValue >= 10 && !whaleTransactions.find(w => w.txid === tx.txid)) {
                    whaleTransactions.unshift({
                        txid: tx.txid,
                        btc: btcValue,
                        fee: tx.fee || 0,
                        time: (block.timestamp || Math.floor(Date.now()/1000)) * 1000,
                        minerType: minerInfo.type,
                        minerName: minerInfo.name
                    });
                    totalVolume += btcValue;
                    if (btcValue > largestTx) largestTx = btcValue;
                }
            });
        }
        
        whaleTransactions = whaleTransactions.slice(0, 50);
        updateUI();
        
    } catch (error) {
        console.error('Block fetch error:', error);
        showEmptyState();
    }
}

function updateUI() {
    soloCount = whaleTransactions.filter(tx => tx.minerType === 'solo').length;
    poolCount = whaleTransactions.filter(tx => tx.minerType === 'pool').length;
    
    document.getElementById('total-volume').textContent = totalVolume.toLocaleString(undefined, {maximumFractionDigits: 0}) + ' BTC';
    document.getElementById('solo-count').textContent = soloCount;
    document.getElementById('pool-count').textContent = poolCount;
    
    const listEl = document.getElementById('whale-list');
    
    if (whaleTransactions.length === 0) {
        showEmptyState();
        return;
    }
    
    listEl.innerHTML = whaleTransactions.map(tx => {
        const usdValue = tx.btc * btcPrice;
        const isMega = tx.btc >= 500;
        const timeAgo = getTimeAgo(tx.time);
        const minerType = tx.minerType || 'unknown';
        const minerName = tx.minerName || 'Unknown';
        
        let iconClass, iconColor, badgeColor, badgeText;
        if (isMega) {
            iconClass = 'fa-crown';
            iconColor = '#eab308';
            badgeColor = '#eab308';
            badgeText = 'MEGA WHALE';
        } else if (minerType === 'solo') {
            iconClass = 'fa-bolt';
            iconColor = '#22c55e';
            badgeColor = '#22c55e';
            badgeText = 'SOLO SLAYER';
        } else if (minerType === 'pool') {
            iconClass = 'fa-building';
            iconColor = '#3b82f6';
            badgeColor = '#3b82f6';
            badgeText = minerName;
        } else {
            iconClass = 'fa-fish';
            iconColor = 'var(--pp-red)';
            badgeColor = '#888';
            badgeText = 'WHALE';
        }
        
        return `
            <div class="whale-tx ${isMega ? 'mega' : ''}" style="border-left: 3px solid ${iconColor};">
                <div class="tx-icon" style="background: ${iconColor}20;">
                    <i class="fas ${iconClass}" style="color: ${iconColor};"></i>
                </div>
                <div class="tx-info">
                    <div class="tx-amount">${tx.btc.toLocaleString(undefined, {maximumFractionDigits: 2})} BTC</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: ${badgeColor}30; color: ${badgeColor}; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 600; text-transform: uppercase;">${badgeText}</span>
                        <div class="tx-hash">
                            <a href="https://mempool.space/tx/${tx.txid}" target="_blank">${tx.txid.substring(0, 16)}...</a>
                        </div>
                    </div>
                </div>
                <div class="tx-usd">$${(usdValue / 1000000).toFixed(2)}M</div>
                <div class="tx-time" title="${new Date(tx.time).toLocaleString()}">${timeAgo}</div>
            </div>
        `;
    }).join('');
}

function showEmptyState() {
    document.getElementById('whale-list').innerHTML = `
        <div class="empty-state">
            <i class="fas fa-water"></i>
            <p>No whale activity detected in recent blocks.<br>Large transactions (10+ BTC) will appear here in real-time.</p>
        </div>
    `;
}

function getTimeAgo(timestamp) {
    let ts = timestamp;
    if (ts < 1000000000000) ts = ts * 1000;
    
    const seconds = Math.floor((Date.now() - ts) / 1000);
    
    if (seconds < 0) return 'just now';
    if (seconds < 60) return seconds + 's ago';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    return Math.floor(seconds / 86400) + 'd ago';
}

fetchBtcPrice();
loadStoredWhales().then(() => fetchWhaleTransactions());

setInterval(fetchBtcPrice, 60000);
setInterval(fetchWhaleTransactions, 30000);
</script>
{% endblock %}
